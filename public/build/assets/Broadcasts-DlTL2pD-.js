import{_ as v,c as n,o as l,a as t,b as a,w as k,d as u,C as p,F as b,q as f,v as m,t as i,D as w,p as x,j as c,e as h}from"./admin-xycicC1N.js";const _={name:"Broadcasts",data(){return{bots:[],users:[],availableUsers:[],selectedUsers:[],loading:!1,usersLoading:!1,sending:!1,previewing:!1,recipientType:"all",showUserSelector:!1,userSearchQuery:"",userSearchTimeout:null,previewResult:null,sendResult:null,form:{bot_id:"",type:"message",telegram_user_ids:null,content:{text:"",photo:"",document:"",caption:""},options:{parse_mode:null,disable_notification:!1}}}},computed:{canPreview(){return this.form.bot_id&&this.form.type&&this.hasContent()},canSend(){return this.canPreview&&(this.recipientType==="all"||this.selectedUsers.length>0)}},mounted(){this.loadBots()},methods:{async loadBots(){try{const r=await c.get("/api/v1/bots");this.bots=r.data.data||[]}catch(r){console.error("Error loading bots:",r)}},async loadUsers(){if(this.form.bot_id){this.usersLoading=!0;try{const r={bot_id:this.form.bot_id,per_page:100,is_blocked:!1};this.userSearchQuery&&(r.search=this.userSearchQuery);const e=await c.get("/api/v1/telegram-users",{params:r});this.availableUsers=e.data.data?.data||[]}catch(r){console.error("Error loading users:",r)}finally{this.usersLoading=!1}}},debounceUserSearch(){clearTimeout(this.userSearchTimeout),this.userSearchTimeout=setTimeout(()=>{this.loadUsers()},500)},handleBotChange(){this.recipientType==="selected"&&(this.selectedUsers=[],this.loadUsers())},handleTypeChange(){this.form.content={text:"",photo:"",document:"",caption:""}},handleRecipientTypeChange(){this.recipientType==="all"?(this.form.telegram_user_ids=null,this.selectedUsers=[]):(this.form.telegram_user_ids=[],this.form.bot_id&&this.loadUsers())},toggleUserSelection(r){const e=this.selectedUsers.findIndex(g=>g.id===r.id);e>=0?this.selectedUsers.splice(e,1):this.selectedUsers.push(r),this.updateFormUserIds()},removeUser(r){this.selectedUsers=this.selectedUsers.filter(e=>e.id!==r),this.updateFormUserIds()},isUserSelected(r){return this.selectedUsers.some(e=>e.id===r)},updateFormUserIds(){this.form.telegram_user_ids=this.selectedUsers.map(r=>r.telegram_id)},hasContent(){return this.form.type==="message"?!!this.form.content.text:this.form.type==="photo"?!!this.form.content.photo:this.form.type==="document"?!!this.form.content.document:!1},getTypeLabel(r){return{message:"Сообщение",photo:"Фото",document:"Документ"}[r]||r},async previewBroadcast(){if(!this.form.bot_id){alert("Выберите бота");return}this.previewing=!0,this.previewResult=null,this.sendResult=null;try{const r={bot_id:this.form.bot_id,type:this.form.type,content:this.form.content,telegram_user_ids:this.recipientType==="all"?null:this.form.telegram_user_ids},e=await c.post("/api/v1/broadcasts/preview",r);this.previewResult=e.data.data}catch(r){alert(r.response?.data?.message||"Ошибка предпросмотра"),console.error("Error previewing broadcast:",r)}finally{this.previewing=!1}},async sendBroadcast(){if(confirm("Вы уверены, что хотите отправить рассылку?")){this.sending=!0,this.sendResult=null;try{const r={bot_id:this.form.bot_id,type:this.form.type,content:this.form.content,options:this.form.options,telegram_user_ids:this.recipientType==="all"?null:this.form.telegram_user_ids},e=await c.post("/api/v1/broadcasts/send",r);e.data.success?(this.sendResult={success:!0,data:e.data.data},setTimeout(()=>{this.resetForm()},5e3)):this.sendResult={success:!1,message:e.data.message||"Ошибка отправки рассылки"}}catch(r){this.sendResult={success:!1,message:r.response?.data?.message||"Ошибка отправки рассылки"},console.error("Error sending broadcast:",r)}finally{this.sending=!1}}},resetForm(){this.form={bot_id:"",type:"message",telegram_user_ids:null,content:{text:"",photo:"",document:"",caption:""},options:{parse_mode:null,disable_notification:!1}},this.recipientType="all",this.selectedUsers=[],this.previewResult=null,this.sendResult=null}},watch:{showUserSelector(r){r&&this.form.bot_id&&this.loadUsers()}}},U={class:"broadcasts-page space-y-6"},T={class:"bg-card rounded-lg border border-border p-6"},R=["value"],C={key:0},S={key:1},B={key:2},V={class:"text-xs text-muted-foreground mt-1"},L={key:0,class:"mt-4"},A={key:0,class:"mt-2 flex flex-wrap gap-2"},M=["onClick"],j={class:"bg-muted/30 rounded-lg p-4"},I={class:"space-y-3"},F={class:"flex items-center gap-2"},q={class:"flex gap-2 pt-4 border-t border-border"},Q=["disabled"],z=["disabled"],D={key:0,class:"mt-6 p-4 bg-muted/50 rounded-lg border border-border"},E={class:"space-y-2"},H={class:"flex justify-between"},N={class:"text-sm font-medium text-foreground"},P={class:"flex justify-between"},G={class:"text-sm font-medium text-foreground"},J={key:0,class:"space-y-2"},K={class:"flex justify-between"},O={class:"text-sm font-medium text-foreground"},W={class:"flex justify-between"},X={class:"text-sm font-medium text-green-500"},Y={class:"flex justify-between"},Z={class:"text-sm font-medium text-red-500"},$={key:1,class:"text-sm text-red-500"},ee={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"},te={class:"bg-background border border-border rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col"},se={class:"sticky top-0 bg-background border-b border-border p-4"},oe={class:"flex items-center justify-between"},re={class:"mt-3"},ne={class:"flex-1 overflow-y-auto p-4"},le={key:0,class:"text-center py-8"},de={key:1,class:"text-center py-8"},ie={key:2,class:"space-y-2"},ue=["value","checked","onChange"],ae={class:"flex-1"},me={class:"font-medium text-foreground"},pe={key:0,class:"text-muted-foreground"},ce={class:"text-sm text-muted-foreground font-mono"},be={class:"sticky bottom-0 bg-background border-t border-border p-4"},fe={class:"flex items-center justify-between"},ge={class:"text-sm text-muted-foreground"};function xe(r,e,g,he,s,d){return l(),n("div",U,[e[48]||(e[48]=t("div",{class:"flex items-center justify-between"},[t("div",null,[t("h1",{class:"text-3xl font-semibold text-foreground"},"Рассылки"),t("p",{class:"text-muted-foreground mt-1"},"Отправка сообщений пользователям бота")])],-1)),t("div",T,[e[44]||(e[44]=t("h2",{class:"text-xl font-semibold text-foreground mb-4"},"Создать рассылку",-1)),t("form",{onSubmit:e[15]||(e[15]=k((...o)=>d.sendBroadcast&&d.sendBroadcast(...o),["prevent"])),class:"space-y-4"},[t("div",null,[e[21]||(e[21]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"Бот *",-1)),u(t("select",{"onUpdate:modelValue":e[0]||(e[0]=o=>s.form.bot_id=o),required:"",class:"w-full h-10 px-3 rounded-lg border border-input bg-background",onChange:e[1]||(e[1]=(...o)=>d.handleBotChange&&d.handleBotChange(...o))},[e[20]||(e[20]=t("option",{value:""},"Выберите бота",-1)),(l(!0),n(b,null,f(s.bots,o=>(l(),n("option",{key:o.id,value:o.id},i(o.name),9,R))),128))],544),[[p,s.form.bot_id]])]),t("div",null,[e[23]||(e[23]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"Тип контента *",-1)),u(t("select",{"onUpdate:modelValue":e[2]||(e[2]=o=>s.form.type=o),required:"",class:"w-full h-10 px-3 rounded-lg border border-input bg-background",onChange:e[3]||(e[3]=(...o)=>d.handleTypeChange&&d.handleTypeChange(...o))},[...e[22]||(e[22]=[t("option",{value:"message"},"Сообщение (текст)",-1),t("option",{value:"photo"},"Фото",-1),t("option",{value:"document"},"Документ",-1)])],544),[[p,s.form.type]])]),s.form.type==="message"?(l(),n("div",C,[e[24]||(e[24]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"Текст сообщения *",-1)),u(t("textarea",{"onUpdate:modelValue":e[4]||(e[4]=o=>s.form.content.text=o),required:"",rows:"6",placeholder:"Введите текст сообщения...",class:"w-full px-3 py-2 rounded-lg border border-input bg-background resize-none font-mono text-sm"},null,512),[[m,s.form.content.text]]),e[25]||(e[25]=t("p",{class:"text-xs text-muted-foreground mt-1"}," Поддерживается HTML форматирование, если выбран parse_mode: HTML ",-1))])):a("",!0),s.form.type==="photo"?(l(),n("div",S,[e[26]||(e[26]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"URL фото или file_id *",-1)),u(t("input",{"onUpdate:modelValue":e[5]||(e[5]=o=>s.form.content.photo=o),type:"text",required:"",placeholder:"https://example.com/photo.jpg или AgACAgIAAxkBAAI...",class:"w-full h-10 px-3 rounded-lg border border-input bg-background font-mono text-sm"},null,512),[[m,s.form.content.photo]]),e[27]||(e[27]=t("p",{class:"text-xs text-muted-foreground mt-1"}," Можно использовать URL изображения или file_id из Telegram ",-1)),e[28]||(e[28]=t("label",{class:"text-sm font-medium text-foreground mb-1 block mt-3"},"Подпись к фото (опционально)",-1)),u(t("textarea",{"onUpdate:modelValue":e[6]||(e[6]=o=>s.form.content.caption=o),rows:"3",placeholder:"Подпись к фото...",class:"w-full px-3 py-2 rounded-lg border border-input bg-background resize-none"},null,512),[[m,s.form.content.caption]])])):a("",!0),s.form.type==="document"?(l(),n("div",B,[e[29]||(e[29]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"URL документа или file_id *",-1)),u(t("input",{"onUpdate:modelValue":e[7]||(e[7]=o=>s.form.content.document=o),type:"text",required:"",placeholder:"https://example.com/document.pdf или BQACAgIAAxkBAAI...",class:"w-full h-10 px-3 rounded-lg border border-input bg-background font-mono text-sm"},null,512),[[m,s.form.content.document]]),e[30]||(e[30]=t("p",{class:"text-xs text-muted-foreground mt-1"}," Можно использовать URL документа или file_id из Telegram ",-1)),e[31]||(e[31]=t("label",{class:"text-sm font-medium text-foreground mb-1 block mt-3"},"Подпись к документу (опционально)",-1)),u(t("textarea",{"onUpdate:modelValue":e[8]||(e[8]=o=>s.form.content.caption=o),rows:"3",placeholder:"Подпись к документу...",class:"w-full px-3 py-2 rounded-lg border border-input bg-background resize-none"},null,512),[[m,s.form.content.caption]])])):a("",!0),t("div",null,[e[33]||(e[33]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"Получатели *",-1)),u(t("select",{"onUpdate:modelValue":e[9]||(e[9]=o=>s.recipientType=o),class:"w-full h-10 px-3 rounded-lg border border-input bg-background mb-2",onChange:e[10]||(e[10]=(...o)=>d.handleRecipientTypeChange&&d.handleRecipientTypeChange(...o))},[...e[32]||(e[32]=[t("option",{value:"all"},"Все пользователи бота",-1),t("option",{value:"selected"},"Выбранные пользователи",-1)])],544),[[p,s.recipientType]]),t("p",V,i(s.recipientType==="all"?"Рассылка будет отправлена всем активным пользователям выбранного бота":"Выберите конкретных пользователей из списка"),1),s.recipientType==="selected"?(l(),n("div",L,[t("button",{type:"button",onClick:e[11]||(e[11]=o=>s.showUserSelector=!0),class:"w-full px-4 py-2 border border-border bg-background/50 hover:bg-accent/10 rounded-lg transition-colors"},i(s.selectedUsers.length>0?`Выбрано пользователей: ${s.selectedUsers.length}`:"Выбрать пользователей"),1),s.selectedUsers.length>0?(l(),n("div",A,[(l(!0),n(b,null,f(s.selectedUsers,o=>(l(),n("span",{key:o.id,class:"inline-flex items-center gap-1 px-2 py-1 bg-blue-500/10 text-blue-500 rounded text-sm"},[h(i(o.first_name||o.username||`ID: ${o.telegram_id}`)+" ",1),t("button",{type:"button",onClick:y=>d.removeUser(o.id),class:"hover:text-blue-700"}," × ",8,M)]))),128))])):a("",!0)])):a("",!0)]),t("div",j,[e[37]||(e[37]=t("label",{class:"text-sm font-medium text-foreground mb-3 block"},"Дополнительные опции",-1)),t("div",I,[t("div",null,[e[35]||(e[35]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"Формат текста (parse_mode)",-1)),u(t("select",{"onUpdate:modelValue":e[12]||(e[12]=o=>s.form.options.parse_mode=o),class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},[...e[34]||(e[34]=[t("option",{value:null},"Без форматирования",-1),t("option",{value:"HTML"},"HTML",-1),t("option",{value:"Markdown"},"Markdown",-1),t("option",{value:"MarkdownV2"},"MarkdownV2",-1)])],512),[[p,s.form.options.parse_mode]])]),t("label",F,[u(t("input",{"onUpdate:modelValue":e[13]||(e[13]=o=>s.form.options.disable_notification=o),type:"checkbox",class:"w-4 h-4"},null,512),[[w,s.form.options.disable_notification]]),e[36]||(e[36]=t("span",{class:"text-sm"},"Отключить уведомления (тихая отправка)",-1))])])]),t("div",q,[t("button",{type:"button",onClick:e[14]||(e[14]=(...o)=>d.previewBroadcast&&d.previewBroadcast(...o)),disabled:s.sending||s.previewing||!d.canPreview,class:"flex-1 px-4 py-2 border border-border bg-background/50 hover:bg-accent/10 rounded-lg transition-colors disabled:opacity-50"},i(s.previewing?"Предпросмотр...":"Предпросмотр"),9,Q),t("button",{type:"submit",disabled:s.sending||s.previewing||!d.canSend,class:"flex-1 px-4 py-2 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-lg transition-colors disabled:opacity-50"},i(s.sending?"Отправка...":"Отправить"),9,z)])],32),s.previewResult?(l(),n("div",D,[e[40]||(e[40]=t("h3",{class:"text-lg font-semibold text-foreground mb-3"},"Предпросмотр рассылки",-1)),t("div",E,[t("div",H,[e[38]||(e[38]=t("span",{class:"text-sm text-muted-foreground"},"Количество получателей:",-1)),t("span",N,i(s.previewResult.recipients_count),1)]),t("div",P,[e[39]||(e[39]=t("span",{class:"text-sm text-muted-foreground"},"Тип контента:",-1)),t("span",G,i(d.getTypeLabel(s.form.type)),1)])])])):a("",!0),s.sendResult?(l(),n("div",{key:1,class:x(["mt-6 p-4 rounded-lg border",s.sendResult.success?"bg-green-500/10 border-green-500/20":"bg-red-500/10 border-red-500/20"])},[t("h3",{class:x(["text-lg font-semibold mb-3",s.sendResult.success?"text-green-500":"text-red-500"])},i(s.sendResult.success?"Рассылка отправлена":"Ошибка отправки"),3),s.sendResult.success&&s.sendResult.data?(l(),n("div",J,[t("div",K,[e[41]||(e[41]=t("span",{class:"text-sm text-muted-foreground"},"Всего получателей:",-1)),t("span",O,i(s.sendResult.data.total),1)]),t("div",W,[e[42]||(e[42]=t("span",{class:"text-sm text-muted-foreground"},"Успешно отправлено:",-1)),t("span",X,i(s.sendResult.data.sent),1)]),t("div",Y,[e[43]||(e[43]=t("span",{class:"text-sm text-muted-foreground"},"Ошибок:",-1)),t("span",Z,i(s.sendResult.data.failed),1)])])):(l(),n("p",$,i(s.sendResult.message),1))],2)):a("",!0)]),s.showUserSelector?(l(),n("div",ee,[t("div",te,[t("div",se,[t("div",oe,[e[45]||(e[45]=t("h3",{class:"text-lg font-semibold"},"Выбор пользователей",-1)),t("button",{onClick:e[16]||(e[16]=o=>s.showUserSelector=!1),class:"text-muted-foreground hover:text-foreground"}," ✕ ")]),t("div",re,[u(t("input",{"onUpdate:modelValue":e[17]||(e[17]=o=>s.userSearchQuery=o),type:"text",placeholder:"Поиск по имени, username, telegram_id...",class:"w-full h-10 px-3 rounded-lg border border-input bg-background",onInput:e[18]||(e[18]=(...o)=>d.debounceUserSearch&&d.debounceUserSearch(...o))},null,544),[[m,s.userSearchQuery]])])]),t("div",ne,[s.usersLoading?(l(),n("div",le,[...e[46]||(e[46]=[t("p",{class:"text-muted-foreground"},"Загрузка пользователей...",-1)])])):s.availableUsers.length===0?(l(),n("div",de,[...e[47]||(e[47]=[t("p",{class:"text-muted-foreground"},"Пользователи не найдены",-1)])])):(l(),n("div",ie,[(l(!0),n(b,null,f(s.availableUsers,o=>(l(),n("label",{key:o.id,class:"flex items-center gap-3 p-3 hover:bg-muted/50 rounded-lg cursor-pointer"},[t("input",{type:"checkbox",value:o.id,checked:d.isUserSelected(o.id),onChange:y=>d.toggleUserSelection(o),class:"w-4 h-4"},null,40,ue),t("div",ae,[t("div",me,[h(i(o.first_name||"")+" "+i(o.last_name||"")+" ",1),o.username?(l(),n("span",pe,"@"+i(o.username),1)):a("",!0)]),t("div",ce,"ID: "+i(o.telegram_id),1)])]))),128))]))]),t("div",be,[t("div",fe,[t("span",ge," Выбрано: "+i(s.selectedUsers.length),1),t("button",{onClick:e[19]||(e[19]=o=>s.showUserSelector=!1),class:"px-4 py-2 bg-accent/10 text-accent border border-accent/40 hover:bg-accent/20 rounded-lg transition-colors"}," Готово ")])])])])):a("",!0)])}const ve=v(_,[["render",xe]]);export{ve as default};
