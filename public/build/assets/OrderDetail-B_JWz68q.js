import{o as h,f as V,g as C}from"./api-BrgWxvgT.js";import{_ as S,j as N,c as d,o as n,a as t,b as m,t as i,d as u,C as c,A as f,v as g,F as v,q as x,p as b,e as y,f as k,g as O,r as w,w as B}from"./admin-Dbz-L3Lt.js";const H={name:"OrderStatusHistory",props:{orderId:{type:[Number,String],required:!0}},data(){return{history:[],loading:!1,error:null,filters:{role:"",status:"",search:""}}},computed:{filteredHistory(){let r=[...this.history];if(this.filters.role&&(r=r.filter(e=>e.role===this.filters.role)),this.filters.status&&(r=r.filter(e=>e.status===this.filters.status)),this.filters.search){const e=this.filters.search.toLowerCase();r=r.filter(p=>(p.comment||"").toLowerCase().includes(e))}return r}},mounted(){this.loadHistory()},methods:{async loadHistory(){this.loading=!0,this.error=null;try{const r=localStorage.getItem("token"),e=await N.get(`/api/v1/orders/${this.orderId}/status-history`,{headers:{Authorization:`Bearer ${r}`,Accept:"application/json"}});this.history=e.data.data||[]}catch(r){this.error=r.response?.data?.message||"Ошибка загрузки истории статусов",console.error("Error loading status history:",r)}finally{this.loading=!1}},translateStatus(r){return{new:"Новый",accepted:"Принят",sent_to_kitchen:"Отправлен на кухню",kitchen_accepted:"Принят кухней",preparing:"Готовится",ready_for_delivery:"Готов к доставке",courier_assigned:"Курьер назначен",in_transit:"В пути",delivered:"Доставлен",cancelled:"Отменен"}[r]||r},translateRole(r){return{admin:"Администратор",kitchen:"Кухня",courier:"Курьер",user:"Клиент"}[r]||r},getStatusColor(r){return{new:"bg-blue-500",accepted:"bg-green-500",sent_to_kitchen:"bg-yellow-500",kitchen_accepted:"bg-yellow-600",preparing:"bg-orange-500",ready_for_delivery:"bg-purple-500",courier_assigned:"bg-indigo-500",in_transit:"bg-blue-600",delivered:"bg-green-600",cancelled:"bg-red-500"}[r]||"bg-gray-500"},getStatusBadgeClass(r){return{new:"bg-blue-500/10 text-blue-500",accepted:"bg-green-500/10 text-green-500",sent_to_kitchen:"bg-yellow-500/10 text-yellow-500",kitchen_accepted:"bg-yellow-600/10 text-yellow-600",preparing:"bg-orange-500/10 text-orange-500",ready_for_delivery:"bg-purple-500/10 text-purple-500",courier_assigned:"bg-indigo-500/10 text-indigo-500",in_transit:"bg-blue-600/10 text-blue-600",delivered:"bg-green-600/10 text-green-600",cancelled:"bg-red-500/10 text-red-500"}[r]||"bg-gray-500/10 text-gray-500"},getRoleBadgeClass(r){return{admin:"bg-purple-500/10 text-purple-500",kitchen:"bg-orange-500/10 text-orange-500",courier:"bg-blue-500/10 text-blue-500",user:"bg-gray-500/10 text-gray-500"}[r]||"bg-gray-500/10 text-gray-500"},getUserName(r){if(r.changed_by_user)return r.changed_by_user.name||r.changed_by_user.email||"Администратор";if(r.changed_by_telegram_user){const e=r.changed_by_telegram_user;return[e.first_name,e.last_name].filter(Boolean).join(" ")||e.username||`User #${e.telegram_id}`}return null},formatDate(r){return r?new Date(r).toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):""}}},I={class:"order-status-history"},j={class:"flex items-center justify-between mb-4"},D=["disabled"],R={key:0,class:"mb-4 flex gap-2 flex-wrap"},q={key:1,class:"text-center py-8 text-muted-foreground"},L={key:2,class:"text-center py-8 text-muted-foreground"},A={key:3,class:"relative"},P={class:"space-y-4"},M={class:"flex-1 ml-8 pb-4"},z={class:"bg-card rounded-lg border border-border p-4"},E={class:"flex items-start justify-between mb-2"},F={class:"flex items-center gap-2"},T={class:"text-xs text-muted-foreground"},J={key:0,class:"text-sm text-muted-foreground mb-2"},G={key:1,class:"text-sm text-muted-foreground mb-2"},K={key:2,class:"text-sm text-foreground mt-2 p-2 bg-muted/30 rounded"},Q={class:"mt-1"},W={key:3,class:"text-xs text-muted-foreground mt-2"},X={class:"cursor-pointer"},Y={class:"mt-2 p-2 bg-muted/20 rounded text-xs overflow-x-auto"};function Z(r,e,p,U,o,a){return n(),d("div",I,[t("div",j,[e[4]||(e[4]=t("h3",{class:"text-lg font-semibold text-foreground"},"История статусов",-1)),t("button",{onClick:e[0]||(e[0]=(...l)=>a.loadHistory&&a.loadHistory(...l)),disabled:o.loading,class:"px-3 py-1.5 text-sm bg-muted hover:bg-muted/80 text-muted-foreground rounded-lg transition-colors disabled:opacity-50"},i(o.loading?"Загрузка...":"Обновить"),9,D)]),o.history.length>0?(n(),d("div",R,[u(t("select",{"onUpdate:modelValue":e[1]||(e[1]=l=>o.filters.role=l),class:"h-9 px-3 text-sm rounded-lg border border-input bg-background text-foreground"},[...e[5]||(e[5]=[f('<option value="" data-v-1f480e28>Все роли</option><option value="admin" data-v-1f480e28>Администратор</option><option value="kitchen" data-v-1f480e28>Кухня</option><option value="courier" data-v-1f480e28>Курьер</option><option value="user" data-v-1f480e28>Клиент</option>',5)])],512),[[c,o.filters.role]]),u(t("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>o.filters.status=l),class:"h-9 px-3 text-sm rounded-lg border border-input bg-background text-foreground"},[...e[6]||(e[6]=[f('<option value="" data-v-1f480e28>Все статусы</option><option value="new" data-v-1f480e28>Новый</option><option value="accepted" data-v-1f480e28>Принят</option><option value="sent_to_kitchen" data-v-1f480e28>Отправлен на кухню</option><option value="kitchen_accepted" data-v-1f480e28>Принят кухней</option><option value="preparing" data-v-1f480e28>Готовится</option><option value="ready_for_delivery" data-v-1f480e28>Готов к доставке</option><option value="courier_assigned" data-v-1f480e28>Курьер назначен</option><option value="in_transit" data-v-1f480e28>В пути</option><option value="delivered" data-v-1f480e28>Доставлен</option><option value="cancelled" data-v-1f480e28>Отменен</option>',11)])],512),[[c,o.filters.status]]),u(t("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>o.filters.search=l),type:"text",placeholder:"Поиск по комментариям...",class:"h-9 px-3 text-sm rounded-lg border border-input bg-background text-foreground flex-1 min-w-[200px]"},null,512),[[g,o.filters.search]])])):m("",!0),o.loading&&o.history.length===0?(n(),d("div",q," Загрузка истории статусов... ")):a.filteredHistory.length===0?(n(),d("div",L,i(o.history.length===0?"История статусов пуста":"Нет записей, соответствующих фильтрам"),1)):(n(),d("div",A,[e[11]||(e[11]=t("div",{class:"absolute left-4 top-0 bottom-0 w-0.5 bg-border"},null,-1)),t("div",P,[(n(!0),d(v,null,x(a.filteredHistory,(l,_)=>(n(),d("div",{key:l.id,class:"relative flex gap-4"},[t("div",{class:b(["absolute left-4 w-3 h-3 rounded-full border-2 border-background -translate-x-1/2",a.getStatusColor(l.status)]),style:{top:"0.5rem"}},null,2),t("div",M,[t("div",z,[t("div",E,[t("div",F,[t("span",{class:b(["px-2 py-1 text-xs font-medium rounded-md",a.getStatusBadgeClass(l.status)])},i(a.translateStatus(l.status)),3),t("span",{class:b(["px-2 py-1 text-xs font-medium rounded-md",a.getRoleBadgeClass(l.role)])},i(a.translateRole(l.role)),3)]),t("span",T,i(a.formatDate(l.created_at)),1)]),l.previous_status?(n(),d("div",J,[e[7]||(e[7]=t("span",{class:"font-medium"},"Предыдущий статус:",-1)),y(" "+i(a.translateStatus(l.previous_status)),1)])):m("",!0),a.getUserName(l)?(n(),d("div",G,[e[8]||(e[8]=t("span",{class:"font-medium"},"Изменил:",-1)),y(" "+i(a.getUserName(l)),1)])):m("",!0),l.comment?(n(),d("div",K,[e[9]||(e[9]=t("span",{class:"font-medium text-muted-foreground"},"Комментарий:",-1)),t("p",Q,i(l.comment),1)])):m("",!0),l.metadata&&Object.keys(l.metadata).length>0?(n(),d("div",W,[t("details",X,[e[10]||(e[10]=t("summary",{class:"font-medium"},"Дополнительная информация",-1)),t("pre",Y,i(JSON.stringify(l.metadata,null,2)),1)])])):m("",!0)])])]))),128))])]))])}const $=S(H,[["render",Z],["__scopeId","data-v-1f480e28"]]),ee={name:"OrderDetail",components:{OrderStatusHistory:$},data(){return{order:null,delivery:null,payments:[],form:{},loading:!1,saving:!1,error:null}},mounted(){this.loadOrder(),this.loadDelivery(),this.loadPayments()},methods:{async loadOrder(){this.loading=!0,this.error=null;try{const r=this.$route.params.id,e=await h.getById(r);this.order=e.data,this.form={status:this.order.status||"new",payment_status:this.order.payment_status||"pending",phone:this.order.phone||"",delivery_address:this.order.delivery_address||"",delivery_time:this.order.delivery_time||"",comment:this.order.comment||"",total_amount:Number(this.order.total_amount)||0,notes:this.order.notes||""}}catch(r){this.error=r.message||"Ошибка загрузки заказа"}finally{this.loading=!1}},async loadDelivery(){try{const r=this.$route.params.id,e=await C.getByOrder(r);this.delivery=e.data}catch(r){console.log("Доставка не найдена:",r)}},async loadPayments(){try{const r=this.$route.params.id,e=await V.getByOrder(r);this.payments=e.data||[]}catch(r){console.log("Ошибка загрузки платежей:",r)}},async handleSubmit(){this.saving=!0;try{const r=this.$route.params.id;await h.update(r,this.form),await this.loadOrder(),alert("Заказ успешно обновлен")}catch(r){alert(r.message||"Ошибка обновления заказа")}finally{this.saving=!1}}}},te={class:"order-detail-page"},re={class:"mb-6"},oe={class:"flex items-center justify-between"},se={class:"text-2xl font-bold text-foreground"},de={key:0,class:"bg-card rounded-lg border border-border p-12 text-center"},ne={key:1,class:"bg-destructive/10 border border-destructive/20 rounded-lg p-4"},le={class:"text-destructive"},ie={key:2,class:"space-y-6"},ae={class:"bg-card rounded-lg border border-border p-6"},ue={class:"grid grid-cols-2 gap-4"},me={class:"col-span-2"},ge={class:"col-span-2"},pe={class:"flex items-center gap-4 pt-4 border-t border-border"},ce=["disabled"],be={class:"bg-card rounded-lg border border-border p-6"},fe={key:0,class:"space-y-2"},ve={class:"flex items-center gap-4"},xe=["src","alt"],ye={class:"font-medium text-foreground"},_e={class:"text-sm text-muted-foreground"},he={class:"font-medium text-foreground"},ke={key:1,class:"text-center py-8 text-muted-foreground"},we={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},Se={class:"bg-card rounded-lg border border-border p-6"},Ue={key:0,class:"space-y-2"},Ve={class:"text-sm"},Ce={class:"ml-2 font-medium text-foreground"},Ne={class:"text-sm"},Oe={class:"ml-2 font-medium text-foreground"},Be={key:0,class:"text-sm"},He={class:"ml-2 font-medium text-foreground"},Ie={key:1,class:"text-sm"},je={class:"ml-2 font-medium text-foreground"},De={key:1,class:"text-center py-4 text-muted-foreground"},Re={class:"bg-card rounded-lg border border-border p-6"},qe={key:0,class:"space-y-2"},Le={class:"text-sm"},Ae={class:"ml-2 font-medium text-foreground"},Pe={class:"text-sm"},Me={class:"ml-2 font-medium text-foreground"},ze={class:"text-sm"},Ee={class:"ml-2 font-medium text-foreground"},Fe={key:1,class:"text-center py-4 text-muted-foreground"},Te={class:"bg-card rounded-lg border border-border p-6"};function Je(r,e,p,U,o,a){const l=w("router-link"),_=w("OrderStatusHistory");return n(),d("div",te,[t("div",re,[t("div",oe,[t("div",null,[t("h1",se,"Заказ #"+i(o.order?.order_id),1),e[9]||(e[9]=t("p",{class:"text-muted-foreground mt-1"},"Детальная информация о заказе",-1))]),k(l,{to:"/orders",class:"h-10 px-4 bg-muted text-muted-foreground rounded-lg hover:bg-muted/80 inline-flex items-center"},{default:O(()=>[...e[10]||(e[10]=[y(" К списку заказов ",-1)])]),_:1})])]),o.loading&&!o.order?(n(),d("div",de,[...e[11]||(e[11]=[t("p",{class:"text-muted-foreground"},"Загрузка заказа...",-1)])])):o.error?(n(),d("div",ne,[t("p",le,i(o.error),1)])):o.order?(n(),d("div",ie,[t("div",ae,[e[22]||(e[22]=t("h2",{class:"text-lg font-semibold text-foreground mb-4 border-b border-border pb-2"},"Основная информация",-1)),t("form",{onSubmit:e[8]||(e[8]=B((...s)=>a.handleSubmit&&a.handleSubmit(...s),["prevent"])),class:"space-y-4"},[t("div",ue,[t("div",null,[e[13]||(e[13]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Статус заказа",-1)),u(t("select",{"onUpdate:modelValue":e[0]||(e[0]=s=>o.form.status=s),class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},[...e[12]||(e[12]=[f('<option value="new">Новый</option><option value="accepted">Принят</option><option value="preparing">Готовится</option><option value="ready_for_delivery">Готов к доставке</option><option value="in_transit">В пути</option><option value="delivered">Доставлен</option><option value="cancelled">Отменен</option>',7)])],512),[[c,o.form.status]])]),t("div",null,[e[15]||(e[15]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Статус оплаты",-1)),u(t("select",{"onUpdate:modelValue":e[1]||(e[1]=s=>o.form.payment_status=s),class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},[...e[14]||(e[14]=[t("option",{value:"pending"},"Ожидает",-1),t("option",{value:"succeeded"},"Оплачен",-1),t("option",{value:"failed"},"Ошибка",-1),t("option",{value:"cancelled"},"Отменен",-1)])],512),[[c,o.form.payment_status]])]),t("div",null,[e[16]||(e[16]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Телефон",-1)),u(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>o.form.phone=s),type:"text",required:"",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,512),[[g,o.form.phone]])]),t("div",null,[e[17]||(e[17]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Общая сумма",-1)),u(t("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>o.form.total_amount=s),type:"number",step:"0.01",required:"",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,512),[[g,o.form.total_amount,void 0,{number:!0}]])]),t("div",me,[e[18]||(e[18]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Адрес доставки",-1)),u(t("textarea",{"onUpdate:modelValue":e[4]||(e[4]=s=>o.form.delivery_address=s),rows:"2",required:"",class:"w-full px-3 py-2 rounded-lg border border-input bg-background"},null,512),[[g,o.form.delivery_address]])]),t("div",null,[e[19]||(e[19]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Время доставки",-1)),u(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>o.form.delivery_time=s),type:"text",required:"",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,512),[[g,o.form.delivery_time]])]),t("div",null,[e[20]||(e[20]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Комментарий",-1)),u(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>o.form.comment=s),type:"text",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,512),[[g,o.form.comment]])]),t("div",ge,[e[21]||(e[21]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Внутренние заметки",-1)),u(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=s=>o.form.notes=s),rows:"3",class:"w-full px-3 py-2 rounded-lg border border-input bg-background"},null,512),[[g,o.form.notes]])])]),t("div",pe,[t("button",{type:"submit",disabled:o.saving,class:"h-10 px-6 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 disabled:opacity-50"},i(o.saving?"Сохранение...":"Сохранить изменения"),9,ce)])],32)]),t("div",be,[e[23]||(e[23]=t("h2",{class:"text-lg font-semibold text-foreground mb-4 border-b border-border pb-2"},"Товары",-1)),o.order.items&&o.order.items.length>0?(n(),d("div",fe,[(n(!0),d(v,null,x(o.order.items,s=>(n(),d("div",{key:s.id,class:"flex items-center justify-between p-4 bg-muted/30 rounded-lg"},[t("div",ve,[s.product_image?(n(),d("img",{key:0,src:s.product_image,alt:s.product_name,class:"w-16 h-16 object-cover rounded-lg"},null,8,xe)):m("",!0),t("div",null,[t("div",ye,i(s.product_name),1),t("div",_e,i(s.quantity)+" шт. × "+i(Number(s.unit_price).toLocaleString("ru-RU"))+" ₽ ",1)])]),t("div",he,i(Number(s.total).toLocaleString("ru-RU"))+" ₽ ",1)]))),128))])):(n(),d("div",ke," Товары не найдены "))]),t("div",we,[t("div",Se,[e[28]||(e[28]=t("h2",{class:"text-lg font-semibold text-foreground mb-4 border-b border-border pb-2"},"Доставка",-1)),o.delivery?(n(),d("div",Ue,[t("div",Ve,[e[24]||(e[24]=t("span",{class:"text-muted-foreground"},"Статус:",-1)),t("span",Ce,i(o.delivery.status),1)]),t("div",Ne,[e[25]||(e[25]=t("span",{class:"text-muted-foreground"},"Тип:",-1)),t("span",Oe,i(o.delivery.delivery_type),1)]),o.delivery.courier_name?(n(),d("div",Be,[e[26]||(e[26]=t("span",{class:"text-muted-foreground"},"Курьер:",-1)),t("span",He,i(o.delivery.courier_name),1)])):m("",!0),o.delivery.tracking_number?(n(),d("div",Ie,[e[27]||(e[27]=t("span",{class:"text-muted-foreground"},"Трек-номер:",-1)),t("span",je,i(o.delivery.tracking_number),1)])):m("",!0)])):(n(),d("div",De," Доставка не создана "))]),t("div",Re,[e[32]||(e[32]=t("h2",{class:"text-lg font-semibold text-foreground mb-4 border-b border-border pb-2"},"Платежи",-1)),o.payments&&o.payments.length>0?(n(),d("div",qe,[(n(!0),d(v,null,x(o.payments,s=>(n(),d("div",{key:s.id,class:"p-3 bg-muted/30 rounded-lg"},[t("div",Le,[e[29]||(e[29]=t("span",{class:"text-muted-foreground"},"Сумма:",-1)),t("span",Ae,i(Number(s.amount).toLocaleString("ru-RU"))+" ₽ ",1)]),t("div",Pe,[e[30]||(e[30]=t("span",{class:"text-muted-foreground"},"Статус:",-1)),t("span",Me,i(s.status),1)]),t("div",ze,[e[31]||(e[31]=t("span",{class:"text-muted-foreground"},"Метод:",-1)),t("span",Ee,i(s.payment_method),1)])]))),128))])):(n(),d("div",Fe," Платежей нет "))]),t("div",Te,[k(_,{"order-id":o.order.id},null,8,["order-id"])])])])):m("",!0)])}const Qe=S(ee,[["render",Je]]);export{Qe as default};
