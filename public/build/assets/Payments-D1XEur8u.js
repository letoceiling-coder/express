import{f as c}from"./api-C00eI-2u.js";import{s as u}from"./swal-C5DxUZ5S.js";import{_ as P,c as a,o as i,a as t,b as f,f as p,g as b,r as k,d as m,v,C as h,A as y,t as n,F as R,q as C,e as _,p as w}from"./admin-kWgE6elD.js";import"./sweetalert2.esm.all-C0u8rGqG.js";const F={name:"Payments",data(){return{payments:[],loading:!1,error:null,searchQuery:"",statusFilter:"",methodFilter:"",sortBy:"created_at",showRefundModal:!1,selectedPaymentForRefund:null,refundAmount:null,refunding:!1,syncingStatus:null}},computed:{filteredPayments(){let s=[...this.payments];if(this.searchQuery){const e=this.searchQuery.toLowerCase();s=s.filter(l=>l.transaction_id&&l.transaction_id.toLowerCase().includes(e)||l.order?.order_id&&l.order.order_id.toLowerCase().includes(e))}return this.statusFilter&&(s=s.filter(e=>e.status===this.statusFilter)),this.methodFilter&&(s=s.filter(e=>e.payment_method===this.methodFilter)),s.sort((e,l)=>this.sortBy==="created_at"?new Date(l.created_at)-new Date(e.created_at):this.sortBy==="amount"?Number(l.amount)-Number(e.amount):this.sortBy==="status"?e.status.localeCompare(l.status):0),s}},mounted(){this.loadPayments().then(()=>{this.syncYooKassaPayments()})},methods:{async loadPayments(){this.loading=!0,this.error=null;try{const s=await c.getAll();return this.payments=s.data?.data||s.data||[],this.payments}catch(s){return this.error=s.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π",[]}finally{this.loading=!1}},async handleStatusChange(s,e){try{await c.updateStatus(s,e),await this.loadPayments()}catch(l){await u.error(l.message||"–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞"),await this.loadPayments()}},isYooKassaPayment(s){return s.payment_provider==="yookassa"&&s.transaction_id},async syncPaymentStatus(s){if(this.isYooKassaPayment(s)){this.syncingStatus=s.id;try{await c.syncStatus(s.id),await this.loadPayments(),await u.success("–°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –ÆKassa")}catch(e){await u.error(e.message||"–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞")}finally{this.syncingStatus=null}}},getStatusLabel(s){return{pending:"–û–∂–∏–¥–∞–µ—Ç",processing:"–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è",succeeded:"–£—Å–ø–µ—à–µ–Ω",failed:"–û—à–∏–±–∫–∞",refunded:"–í–æ–∑–≤—Ä–∞—â–µ–Ω",partially_refunded:"–ß–∞—Å—Ç–∏—á–Ω–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω",cancelled:"–û—Ç–º–µ–Ω–µ–Ω"}[s]||s},handleRefund(s){this.selectedPaymentForRefund=s,this.refundAmount=null,this.showRefundModal=!0},async confirmRefund(){if(this.selectedPaymentForRefund){this.refunding=!0;try{await c.refund(this.selectedPaymentForRefund.id,this.refundAmount||null),this.showRefundModal=!1,this.selectedPaymentForRefund=null,this.refundAmount=null,await this.loadPayments(),await u.success("–í–æ–∑–≤—Ä–∞—Ç –ø–ª–∞—Ç–µ–∂–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω")}catch(s){await u.error(s.message||"–û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞")}finally{this.refunding=!1}}},async handleDelete(s){if((await u.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç–µ–∂ –¥–ª—è –∑–∞–∫–∞–∑–∞ #${s.order?.order_id||s.order_id}?`,"–£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞","–£–¥–∞–ª–∏—Ç—å","–û—Ç–º–µ–Ω–∞")).isConfirmed)try{await c.delete(s.id),await this.loadPayments(),await u.success("–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω")}catch(l){await u.error(l.message||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞")}},getPaymentMethodLabel(s){return{card:"–ö–∞—Ä—Ç–∞",cash:"–ù–∞–ª–∏—á–Ω—ã–µ",online:"–û–Ω–ª–∞–π–Ω",bank_transfer:"–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥",other:"–î—Ä—É–≥–æ–µ"}[s]||s},getStatusClass(s){return{pending:"bg-yellow-100 text-yellow-800",processing:"bg-blue-100 text-blue-800",succeeded:"bg-green-100 text-green-800",failed:"bg-red-100 text-red-800",refunded:"bg-gray-100 text-gray-800",partially_refunded:"bg-orange-100 text-orange-800",cancelled:"bg-red-100 text-red-800"}[s]||""},formatDate(s){return s?new Date(s).toLocaleDateString("ru-RU"):"‚Äî"},async syncYooKassaPayments(){try{if(this.payments.filter(e=>this.isYooKassaPayment(e)&&(e.status==="pending"||e.status==="processing")).length===0)return;await c.syncAllStatuses(),await this.loadPayments()}catch(s){console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤:",s)}}}},S={class:"payments-page"},L={class:"mb-6 flex items-center justify-between"},A={class:"bg-card rounded-lg border border-border p-4 mb-6"},D={class:"flex gap-4 items-end flex-wrap"},K={class:"flex-1 min-w-[200px]"},V={key:0,class:"bg-card rounded-lg border border-border p-12 text-center"},B={key:1,class:"bg-destructive/10 border border-destructive/20 rounded-lg p-4"},M={class:"text-destructive"},N={key:2,class:"bg-card rounded-lg border border-border overflow-hidden"},U={class:"w-full"},Y={class:"divide-y divide-border"},Q={class:"px-6 py-4"},j={class:"px-6 py-4"},T={class:"text-sm font-medium text-foreground"},q={key:0,class:"text-xs text-muted-foreground"},z={class:"px-6 py-4"},I={class:"text-sm text-foreground"},E={class:"px-6 py-4"},G={class:"text-sm text-muted-foreground"},H={class:"px-6 py-4"},J={key:0,class:"flex items-center gap-2"},O=["onClick","disabled"],W=["value","onChange"],X={class:"px-6 py-4"},Z={class:"text-xs text-muted-foreground font-mono"},$={class:"px-6 py-4"},ee={class:"text-sm text-foreground"},te={class:"px-6 py-4 text-right"},se={class:"flex items-center justify-end gap-2"},oe=["onClick"],re=["onClick"],ne={key:0,class:"p-12 text-center"},de={key:3,class:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center"},le={class:"bg-card rounded-lg border border-border p-6 max-w-md w-full"},ae={class:"space-y-4"},ie=["max"],ue={key:0,class:"mt-1 text-xs text-muted-foreground"},ce={class:"flex gap-4"},fe=["disabled"];function me(s,e,l,ge,r,d){const x=k("router-link");return i(),a("div",S,[t("div",L,[e[8]||(e[8]=t("div",null,[t("h1",{class:"text-2xl font-bold text-foreground"},"–ü–ª–∞—Ç–µ–∂–∏"),t("p",{class:"text-muted-foreground mt-1"},"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞–º–∏")],-1)),p(x,{to:"/payments/create",class:"h-10 px-4 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 inline-flex items-center gap-2"},{default:b(()=>[...e[7]||(e[7]=[t("span",null,"+",-1),t("span",null,"–°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂",-1)])]),_:1})]),t("div",A,[t("div",D,[t("div",K,[e[9]||(e[9]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"–ü–æ–∏—Å–∫",-1)),m(t("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>r.searchQuery=o),type:"text",placeholder:"–ü–æ–∏—Å–∫ –ø–æ transaction_id, –Ω–æ–º–µ—Ä—É –∑–∞–∫–∞–∑–∞...",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,512),[[v,r.searchQuery]])]),t("div",null,[e[11]||(e[11]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"–°—Ç–∞—Ç—É—Å",-1)),m(t("select",{"onUpdate:modelValue":e[1]||(e[1]=o=>r.statusFilter=o),class:"h-10 px-3 rounded-lg border border-input bg-background"},[...e[10]||(e[10]=[y('<option value="">–í—Å–µ</option><option value="pending">–û–∂–∏–¥–∞–µ—Ç</option><option value="processing">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è</option><option value="succeeded">–£—Å–ø–µ—à–µ–Ω</option><option value="failed">–û—à–∏–±–∫–∞</option><option value="refunded">–í–æ–∑–≤—Ä–∞—â–µ–Ω</option><option value="partially_refunded">–ß–∞—Å—Ç–∏—á–Ω–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω</option><option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω</option>',8)])],512),[[h,r.statusFilter]])]),t("div",null,[e[13]||(e[13]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"–ú–µ—Ç–æ–¥",-1)),m(t("select",{"onUpdate:modelValue":e[2]||(e[2]=o=>r.methodFilter=o),class:"h-10 px-3 rounded-lg border border-input bg-background"},[...e[12]||(e[12]=[y('<option value="">–í—Å–µ</option><option value="card">–ö–∞—Ä—Ç–∞</option><option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option><option value="online">–û–Ω–ª–∞–π–Ω</option><option value="bank_transfer">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥</option><option value="other">–î—Ä—É–≥–æ–µ</option>',6)])],512),[[h,r.methodFilter]])]),t("div",null,[e[15]||(e[15]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞",-1)),m(t("select",{"onUpdate:modelValue":e[3]||(e[3]=o=>r.sortBy=o),class:"h-10 px-3 rounded-lg border border-input bg-background"},[...e[14]||(e[14]=[t("option",{value:"created_at"},"–ü–æ –¥–∞—Ç–µ",-1),t("option",{value:"amount"},"–ü–æ —Å—É–º–º–µ",-1),t("option",{value:"status"},"–ü–æ —Å—Ç–∞—Ç—É—Å—É",-1)])],512),[[h,r.sortBy]])])])]),r.loading?(i(),a("div",V,[...e[16]||(e[16]=[t("p",{class:"text-muted-foreground"},"–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π...",-1)])])):r.error?(i(),a("div",B,[t("p",M,n(r.error),1)])):(i(),a("div",N,[t("table",U,[e[19]||(e[19]=t("thead",{class:"bg-muted/50"},[t("tr",null,[t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"–ó–∞–∫–∞–∑"),t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"–°—É–º–º–∞"),t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"–ú–µ—Ç–æ–¥"),t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"–ü—Ä–æ–≤–∞–π–¥–µ—Ä"),t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"–°—Ç–∞—Ç—É—Å"),t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Transaction ID"),t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"–î–∞—Ç–∞"),t("th",{class:"px-6 py-3 text-right text-sm font-medium text-foreground"},"–î–µ–π—Å—Ç–≤–∏—è")])],-1)),t("tbody",Y,[(i(!0),a(R,null,C(d.filteredPayments,o=>(i(),a("tr",{key:o.id},[t("td",Q,[p(x,{to:`/orders/${o.order_id}`,class:"text-sm font-medium text-accent hover:underline"},{default:b(()=>[_(" #"+n(o.order?.order_id||o.order_id),1)]),_:2},1032,["to"])]),t("td",j,[t("div",T,n(Number(o.amount).toLocaleString("ru-RU"))+" "+n(o.currency||"‚ÇΩ"),1),o.refunded_amount>0?(i(),a("div",q," –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ: "+n(Number(o.refunded_amount).toLocaleString("ru-RU"))+" "+n(o.currency||"‚ÇΩ"),1)):f("",!0)]),t("td",z,[t("span",I,n(d.getPaymentMethodLabel(o.payment_method)),1)]),t("td",E,[t("span",G,n(o.payment_provider||"‚Äî"),1)]),t("td",H,[d.isYooKassaPayment(o)?(i(),a("div",J,[t("span",{class:w(["text-xs px-2 py-1 rounded",d.getStatusClass(o.status)])},n(d.getStatusLabel(o.status)),3),t("button",{onClick:g=>d.syncPaymentStatus(o),disabled:r.syncingStatus===o.id,class:"text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200 disabled:opacity-50",title:"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å –ÆKassa"},n(r.syncingStatus===o.id?"...":"üîÑ"),9,O)])):(i(),a("select",{key:1,value:o.status,onChange:g=>d.handleStatusChange(o.id,g.target.value),class:w(["text-xs px-2 py-1 rounded border border-input bg-background",d.getStatusClass(o.status)])},[...e[17]||(e[17]=[y('<option value="pending">–û–∂–∏–¥–∞–µ—Ç</option><option value="processing">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è</option><option value="succeeded">–£—Å–ø–µ—à–µ–Ω</option><option value="failed">–û—à–∏–±–∫–∞</option><option value="refunded">–í–æ–∑–≤—Ä–∞—â–µ–Ω</option><option value="partially_refunded">–ß–∞—Å—Ç–∏—á–Ω–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω</option><option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω</option>',7)])],42,W))]),t("td",X,[t("span",Z,n(o.transaction_id||"‚Äî"),1)]),t("td",$,[t("span",ee,n(d.formatDate(o.created_at)),1)]),t("td",te,[t("div",se,[p(x,{to:`/payments/${o.id}/edit`,class:"h-8 px-3 text-sm bg-accent/10 text-accent rounded-lg hover:bg-accent/20"},{default:b(()=>[...e[18]||(e[18]=[_(" –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ",-1)])]),_:1},8,["to"]),o.status==="succeeded"&&o.refunded_amount<o.amount?(i(),a("button",{key:0,onClick:g=>d.handleRefund(o),class:"h-8 px-3 text-sm bg-orange-100 text-orange-800 rounded-lg hover:bg-orange-200"}," –í–æ–∑–≤—Ä–∞—Ç ",8,oe)):f("",!0),t("button",{onClick:g=>d.handleDelete(o),class:"h-8 px-3 text-sm bg-destructive/10 text-destructive rounded-lg hover:bg-destructive/20"}," –£–¥–∞–ª–∏—Ç—å ",8,re)])])]))),128))])]),d.filteredPayments.length===0?(i(),a("div",ne,[...e[20]||(e[20]=[t("p",{class:"text-muted-foreground"},"–ü–ª–∞—Ç–µ–∂–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã",-1)])])):f("",!0)])),r.showRefundModal?(i(),a("div",de,[t("div",le,[e[22]||(e[22]=t("h2",{class:"text-xl font-bold text-foreground mb-4"},"–í–æ–∑–≤—Ä–∞—Ç –ø–ª–∞—Ç–µ–∂–∞",-1)),t("div",ae,[t("div",null,[e[21]||(e[21]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},[_(" –°—É–º–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ "),t("span",{class:"text-muted-foreground text-xs"},"(–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞)")],-1)),m(t("input",{"onUpdate:modelValue":e[4]||(e[4]=o=>r.refundAmount=o),type:"number",step:"0.01",min:.01,max:r.selectedPaymentForRefund?r.selectedPaymentForRefund.amount-r.selectedPaymentForRefund.refunded_amount:0,placeholder:"–ü–æ–ª–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,8,ie),[[v,r.refundAmount,void 0,{number:!0}]]),r.selectedPaymentForRefund?(i(),a("p",ue," –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞: "+n((r.selectedPaymentForRefund.amount-r.selectedPaymentForRefund.refunded_amount).toLocaleString("ru-RU"))+" "+n(r.selectedPaymentForRefund.currency||"‚ÇΩ"),1)):f("",!0)]),t("div",ce,[t("button",{onClick:e[5]||(e[5]=(...o)=>d.confirmRefund&&d.confirmRefund(...o)),disabled:r.refunding,class:"flex-1 h-10 px-4 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50"},n(r.refunding?"–í–æ–∑–≤—Ä–∞—Ç...":"–í–µ—Ä–Ω—É—Ç—å"),9,fe),t("button",{onClick:e[6]||(e[6]=o=>{r.showRefundModal=!1,r.selectedPaymentForRefund=null,r.refundAmount=null}),class:"flex-1 h-10 px-4 bg-muted text-muted-foreground rounded-lg hover:bg-muted/80"}," –û—Ç–º–µ–Ω–∞ ")])])])])):f("",!0)])}const ye=P(F,[["render",me]]);export{ye as default};
