import{f}from"./api-CnXMImi3.js";import{_,c as l,o as u,a as t,b as a,f as x,g,r as k,d as c,v,C as b,A as h,t as n,F as w,q as P,e as y,p as R}from"./admin-DfKgUlNR.js";const F={name:"Payments",data(){return{payments:[],loading:!1,error:null,searchQuery:"",statusFilter:"",methodFilter:"",sortBy:"created_at",showRefundModal:!1,selectedPaymentForRefund:null,refundAmount:null,refunding:!1}},computed:{filteredPayments(){let s=[...this.payments];if(this.searchQuery){const e=this.searchQuery.toLowerCase();s=s.filter(d=>d.transaction_id&&d.transaction_id.toLowerCase().includes(e)||d.order?.order_id&&d.order.order_id.toLowerCase().includes(e))}return this.statusFilter&&(s=s.filter(e=>e.status===this.statusFilter)),this.methodFilter&&(s=s.filter(e=>e.payment_method===this.methodFilter)),s.sort((e,d)=>this.sortBy==="created_at"?new Date(d.created_at)-new Date(e.created_at):this.sortBy==="amount"?Number(d.amount)-Number(e.amount):this.sortBy==="status"?e.status.localeCompare(d.status):0),s}},mounted(){this.loadPayments()},methods:{async loadPayments(){this.loading=!0,this.error=null;try{const s=await f.getAll();this.payments=s.data?.data||s.data||[]}catch(s){this.error=s.message||"Ошибка загрузки платежей"}finally{this.loading=!1}},async handleStatusChange(s,e){try{await f.updateStatus(s,e),await this.loadPayments()}catch(d){alert(d.message||"Ошибка изменения статуса"),await this.loadPayments()}},handleRefund(s){this.selectedPaymentForRefund=s,this.refundAmount=null,this.showRefundModal=!0},async confirmRefund(){if(this.selectedPaymentForRefund){this.refunding=!0;try{await f.refund(this.selectedPaymentForRefund.id,this.refundAmount||null),this.showRefundModal=!1,this.selectedPaymentForRefund=null,this.refundAmount=null,await this.loadPayments()}catch(s){alert(s.message||"Ошибка возврата платежа")}finally{this.refunding=!1}}},async handleDelete(s){if(confirm(`Вы уверены, что хотите удалить платеж для заказа #${s.order?.order_id||s.order_id}?`))try{await f.delete(s.id),await this.loadPayments()}catch(e){alert(e.message||"Ошибка удаления платежа")}},getPaymentMethodLabel(s){return{card:"Карта",cash:"Наличные",online:"Онлайн",bank_transfer:"Банковский перевод",other:"Другое"}[s]||s},getStatusClass(s){return{pending:"bg-yellow-100 text-yellow-800",processing:"bg-blue-100 text-blue-800",succeeded:"bg-green-100 text-green-800",failed:"bg-red-100 text-red-800",refunded:"bg-gray-100 text-gray-800",partially_refunded:"bg-orange-100 text-orange-800",cancelled:"bg-red-100 text-red-800"}[s]||""},formatDate(s){return s?new Date(s).toLocaleDateString("ru-RU"):"—"}}},C={class:"payments-page"},D={class:"mb-6 flex items-center justify-between"},S={class:"bg-card rounded-lg border border-border p-4 mb-6"},A={class:"flex gap-4 items-end flex-wrap"},L={class:"flex-1 min-w-[200px]"},V={key:0,class:"bg-card rounded-lg border border-border p-12 text-center"},B={key:1,class:"bg-destructive/10 border border-destructive/20 rounded-lg p-4"},M={class:"text-destructive"},N={key:2,class:"bg-card rounded-lg border border-border overflow-hidden"},U={class:"w-full"},Q={class:"divide-y divide-border"},j={class:"px-6 py-4"},T={class:"px-6 py-4"},q={class:"text-sm font-medium text-foreground"},z={key:0,class:"text-xs text-muted-foreground"},I={class:"px-6 py-4"},E={class:"text-sm text-foreground"},G={class:"px-6 py-4"},H={class:"text-sm text-muted-foreground"},J={class:"px-6 py-4"},K=["value","onChange"],O={class:"px-6 py-4"},W={class:"text-xs text-muted-foreground font-mono"},X={class:"px-6 py-4"},Y={class:"text-sm text-foreground"},Z={class:"px-6 py-4 text-right"},$={class:"flex items-center justify-end gap-2"},ee=["onClick"],te=["onClick"],oe={key:0,class:"p-12 text-center"},se={key:3,class:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center"},re={class:"bg-card rounded-lg border border-border p-6 max-w-md w-full"},ne={class:"space-y-4"},de=["max"],le={key:0,class:"mt-1 text-xs text-muted-foreground"},ue={class:"flex gap-4"},ie=["disabled"];function ae(s,e,d,ce,r,i){const m=k("router-link");return u(),l("div",C,[t("div",D,[e[8]||(e[8]=t("div",null,[t("h1",{class:"text-2xl font-bold text-foreground"},"Платежи"),t("p",{class:"text-muted-foreground mt-1"},"Управление платежами")],-1)),x(m,{to:"/payments/create",class:"h-10 px-4 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 inline-flex items-center gap-2"},{default:g(()=>[...e[7]||(e[7]=[t("span",null,"+",-1),t("span",null,"Создать платеж",-1)])]),_:1})]),t("div",S,[t("div",A,[t("div",L,[e[9]||(e[9]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"Поиск",-1)),c(t("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>r.searchQuery=o),type:"text",placeholder:"Поиск по transaction_id, номеру заказа...",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,512),[[v,r.searchQuery]])]),t("div",null,[e[11]||(e[11]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"Статус",-1)),c(t("select",{"onUpdate:modelValue":e[1]||(e[1]=o=>r.statusFilter=o),class:"h-10 px-3 rounded-lg border border-input bg-background"},[...e[10]||(e[10]=[h('<option value="">Все</option><option value="pending">Ожидает</option><option value="processing">Обрабатывается</option><option value="succeeded">Успешен</option><option value="failed">Ошибка</option><option value="refunded">Возвращен</option><option value="partially_refunded">Частично возвращен</option><option value="cancelled">Отменен</option>',8)])],512),[[b,r.statusFilter]])]),t("div",null,[e[13]||(e[13]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"Метод",-1)),c(t("select",{"onUpdate:modelValue":e[2]||(e[2]=o=>r.methodFilter=o),class:"h-10 px-3 rounded-lg border border-input bg-background"},[...e[12]||(e[12]=[h('<option value="">Все</option><option value="card">Карта</option><option value="cash">Наличные</option><option value="online">Онлайн</option><option value="bank_transfer">Банковский перевод</option><option value="other">Другое</option>',6)])],512),[[b,r.methodFilter]])]),t("div",null,[e[15]||(e[15]=t("label",{class:"text-sm font-medium text-foreground mb-1 block"},"Сортировка",-1)),c(t("select",{"onUpdate:modelValue":e[3]||(e[3]=o=>r.sortBy=o),class:"h-10 px-3 rounded-lg border border-input bg-background"},[...e[14]||(e[14]=[t("option",{value:"created_at"},"По дате",-1),t("option",{value:"amount"},"По сумме",-1),t("option",{value:"status"},"По статусу",-1)])],512),[[b,r.sortBy]])])])]),r.loading?(u(),l("div",V,[...e[16]||(e[16]=[t("p",{class:"text-muted-foreground"},"Загрузка платежей...",-1)])])):r.error?(u(),l("div",B,[t("p",M,n(r.error),1)])):(u(),l("div",N,[t("table",U,[e[19]||(e[19]=t("thead",{class:"bg-muted/50"},[t("tr",null,[t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Заказ"),t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Сумма"),t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Метод"),t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Провайдер"),t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Статус"),t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Transaction ID"),t("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Дата"),t("th",{class:"px-6 py-3 text-right text-sm font-medium text-foreground"},"Действия")])],-1)),t("tbody",Q,[(u(!0),l(w,null,P(i.filteredPayments,o=>(u(),l("tr",{key:o.id},[t("td",j,[x(m,{to:`/orders/${o.order_id}`,class:"text-sm font-medium text-accent hover:underline"},{default:g(()=>[y(" #"+n(o.order?.order_id||o.order_id),1)]),_:2},1032,["to"])]),t("td",T,[t("div",q,n(Number(o.amount).toLocaleString("ru-RU"))+" "+n(o.currency||"₽"),1),o.refunded_amount>0?(u(),l("div",z," Возвращено: "+n(Number(o.refunded_amount).toLocaleString("ru-RU"))+" "+n(o.currency||"₽"),1)):a("",!0)]),t("td",I,[t("span",E,n(i.getPaymentMethodLabel(o.payment_method)),1)]),t("td",G,[t("span",H,n(o.payment_provider||"—"),1)]),t("td",J,[t("select",{value:o.status,onChange:p=>i.handleStatusChange(o.id,p.target.value),class:R(["text-xs px-2 py-1 rounded border border-input bg-background",i.getStatusClass(o.status)])},[...e[17]||(e[17]=[h('<option value="pending">Ожидает</option><option value="processing">Обрабатывается</option><option value="succeeded">Успешен</option><option value="failed">Ошибка</option><option value="refunded">Возвращен</option><option value="partially_refunded">Частично возвращен</option><option value="cancelled">Отменен</option>',7)])],42,K)]),t("td",O,[t("span",W,n(o.transaction_id||"—"),1)]),t("td",X,[t("span",Y,n(i.formatDate(o.created_at)),1)]),t("td",Z,[t("div",$,[x(m,{to:`/payments/${o.id}/edit`,class:"h-8 px-3 text-sm bg-accent/10 text-accent rounded-lg hover:bg-accent/20"},{default:g(()=>[...e[18]||(e[18]=[y(" Редактировать ",-1)])]),_:1},8,["to"]),o.status==="succeeded"&&o.refunded_amount<o.amount?(u(),l("button",{key:0,onClick:p=>i.handleRefund(o),class:"h-8 px-3 text-sm bg-orange-100 text-orange-800 rounded-lg hover:bg-orange-200"}," Возврат ",8,ee)):a("",!0),t("button",{onClick:p=>i.handleDelete(o),class:"h-8 px-3 text-sm bg-destructive/10 text-destructive rounded-lg hover:bg-destructive/20"}," Удалить ",8,te)])])]))),128))])]),i.filteredPayments.length===0?(u(),l("div",oe,[...e[20]||(e[20]=[t("p",{class:"text-muted-foreground"},"Платежи не найдены",-1)])])):a("",!0)])),r.showRefundModal?(u(),l("div",se,[t("div",re,[e[22]||(e[22]=t("h2",{class:"text-xl font-bold text-foreground mb-4"},"Возврат платежа",-1)),t("div",ne,[t("div",null,[e[21]||(e[21]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},[y(" Сумма возврата "),t("span",{class:"text-muted-foreground text-xs"},"(оставьте пустым для полного возврата)")],-1)),c(t("input",{"onUpdate:modelValue":e[4]||(e[4]=o=>r.refundAmount=o),type:"number",step:"0.01",min:.01,max:r.selectedPaymentForRefund?r.selectedPaymentForRefund.amount-r.selectedPaymentForRefund.refunded_amount:0,placeholder:"Полный возврат",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,8,de),[[v,r.refundAmount,void 0,{number:!0}]]),r.selectedPaymentForRefund?(u(),l("p",le," Доступно для возврата: "+n((r.selectedPaymentForRefund.amount-r.selectedPaymentForRefund.refunded_amount).toLocaleString("ru-RU"))+" "+n(r.selectedPaymentForRefund.currency||"₽"),1)):a("",!0)]),t("div",ue,[t("button",{onClick:e[5]||(e[5]=(...o)=>i.confirmRefund&&i.confirmRefund(...o)),disabled:r.refunding,class:"flex-1 h-10 px-4 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50"},n(r.refunding?"Возврат...":"Вернуть"),9,ie),t("button",{onClick:e[6]||(e[6]=o=>{r.showRefundModal=!1,r.selectedPaymentForRefund=null,r.refundAmount=null}),class:"flex-1 h-10 px-4 bg-muted text-muted-foreground rounded-lg hover:bg-muted/80"}," Отмена ")])])])])):a("",!0)])}const pe=_(F,[["render",ae]]);export{pe as default};
