import{o as h,f as C,g as N}from"./api-DRy2cUet.js";import{_ as U,j as O,c as d,o as n,a as t,b as m,t as i,d as u,C as c,A as f,v as g,F as v,q as x,p as b,e as y,f as k,g as B,r as w,w as H}from"./admin-DjMp7ShK.js";import{s as S}from"./swal-C5DxUZ5S.js";import"./sweetalert2.esm.all-C0u8rGqG.js";const I={name:"OrderStatusHistory",props:{orderId:{type:[Number,String],required:!0}},data(){return{history:[],loading:!1,error:null,filters:{role:"",status:"",search:""}}},computed:{filteredHistory(){let o=[...this.history];if(this.filters.role&&(o=o.filter(e=>e.role===this.filters.role)),this.filters.status&&(o=o.filter(e=>e.status===this.filters.status)),this.filters.search){const e=this.filters.search.toLowerCase();o=o.filter(p=>(p.comment||"").toLowerCase().includes(e))}return o}},mounted(){this.loadHistory()},methods:{async loadHistory(){this.loading=!0,this.error=null;try{const o=localStorage.getItem("token"),e=await O.get(`/api/v1/orders/${this.orderId}/status-history`,{headers:{Authorization:`Bearer ${o}`,Accept:"application/json"}});this.history=e.data.data||[]}catch(o){this.error=o.response?.data?.message||"Ошибка загрузки истории статусов",console.error("Error loading status history:",o)}finally{this.loading=!1}},translateStatus(o){return{new:"Новый",accepted:"Принят",sent_to_kitchen:"Отправлен на кухню",kitchen_accepted:"Принят кухней",preparing:"Готовится",ready_for_delivery:"Готов к доставке",courier_assigned:"Курьер назначен",in_transit:"В пути",delivered:"Доставлен",cancelled:"Отменен"}[o]||o},translateRole(o){return{admin:"Администратор",kitchen:"Кухня",courier:"Курьер",user:"Клиент"}[o]||o},getStatusColor(o){return{new:"bg-blue-500",accepted:"bg-green-500",sent_to_kitchen:"bg-yellow-500",kitchen_accepted:"bg-yellow-600",preparing:"bg-orange-500",ready_for_delivery:"bg-purple-500",courier_assigned:"bg-indigo-500",in_transit:"bg-blue-600",delivered:"bg-green-600",cancelled:"bg-red-500"}[o]||"bg-gray-500"},getStatusBadgeClass(o){return{new:"bg-blue-500/10 text-blue-500",accepted:"bg-green-500/10 text-green-500",sent_to_kitchen:"bg-yellow-500/10 text-yellow-500",kitchen_accepted:"bg-yellow-600/10 text-yellow-600",preparing:"bg-orange-500/10 text-orange-500",ready_for_delivery:"bg-purple-500/10 text-purple-500",courier_assigned:"bg-indigo-500/10 text-indigo-500",in_transit:"bg-blue-600/10 text-blue-600",delivered:"bg-green-600/10 text-green-600",cancelled:"bg-red-500/10 text-red-500"}[o]||"bg-gray-500/10 text-gray-500"},getRoleBadgeClass(o){return{admin:"bg-purple-500/10 text-purple-500",kitchen:"bg-orange-500/10 text-orange-500",courier:"bg-blue-500/10 text-blue-500",user:"bg-gray-500/10 text-gray-500"}[o]||"bg-gray-500/10 text-gray-500"},getUserName(o){if(o.changed_by_user)return o.changed_by_user.name||o.changed_by_user.email||"Администратор";if(o.changed_by_telegram_user){const e=o.changed_by_telegram_user;return[e.first_name,e.last_name].filter(Boolean).join(" ")||e.username||`User #${e.telegram_id}`}return null},formatDate(o){return o?new Date(o).toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):""}}},j={class:"order-status-history"},D={class:"flex items-center justify-between mb-4"},R=["disabled"],q={key:0,class:"mb-4 flex gap-2 flex-wrap"},L={key:1,class:"text-center py-8 text-muted-foreground"},A={key:2,class:"text-center py-8 text-muted-foreground"},P={key:3,class:"relative"},M={class:"space-y-4"},z={class:"flex-1 ml-8 pb-4"},E={class:"bg-card rounded-lg border border-border p-4"},F={class:"flex items-start justify-between mb-2"},T={class:"flex items-center gap-2"},J={class:"text-xs text-muted-foreground"},G={key:0,class:"text-sm text-muted-foreground mb-2"},K={key:1,class:"text-sm text-muted-foreground mb-2"},Q={key:2,class:"text-sm text-foreground mt-2 p-2 bg-muted/30 rounded"},W={class:"mt-1"},X={key:3,class:"text-xs text-muted-foreground mt-2"},Y={class:"cursor-pointer"},Z={class:"mt-2 p-2 bg-muted/20 rounded text-xs overflow-x-auto"};function $(o,e,p,V,r,a){return n(),d("div",j,[t("div",D,[e[4]||(e[4]=t("h3",{class:"text-lg font-semibold text-foreground"},"История статусов",-1)),t("button",{onClick:e[0]||(e[0]=(...l)=>a.loadHistory&&a.loadHistory(...l)),disabled:r.loading,class:"px-3 py-1.5 text-sm bg-muted hover:bg-muted/80 text-muted-foreground rounded-lg transition-colors disabled:opacity-50"},i(r.loading?"Загрузка...":"Обновить"),9,R)]),r.history.length>0?(n(),d("div",q,[u(t("select",{"onUpdate:modelValue":e[1]||(e[1]=l=>r.filters.role=l),class:"h-9 px-3 text-sm rounded-lg border border-input bg-background text-foreground"},[...e[5]||(e[5]=[f('<option value="" data-v-d4754d19>Все роли</option><option value="admin" data-v-d4754d19>Администратор</option><option value="kitchen" data-v-d4754d19>Кухня</option><option value="courier" data-v-d4754d19>Курьер</option><option value="user" data-v-d4754d19>Клиент</option>',5)])],512),[[c,r.filters.role]]),u(t("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>r.filters.status=l),class:"h-9 px-3 text-sm rounded-lg border border-input bg-background text-foreground"},[...e[6]||(e[6]=[f('<option value="" data-v-d4754d19>Все статусы</option><option value="new" data-v-d4754d19>Новый</option><option value="accepted" data-v-d4754d19>Принят</option><option value="sent_to_kitchen" data-v-d4754d19>Отправлен на кухню</option><option value="kitchen_accepted" data-v-d4754d19>Принят кухней</option><option value="preparing" data-v-d4754d19>Готовится</option><option value="ready_for_delivery" data-v-d4754d19>Готов к доставке</option><option value="courier_assigned" data-v-d4754d19>Курьер назначен</option><option value="in_transit" data-v-d4754d19>В пути</option><option value="delivered" data-v-d4754d19>Доставлен</option><option value="cancelled" data-v-d4754d19>Отменен</option>',11)])],512),[[c,r.filters.status]]),u(t("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>r.filters.search=l),type:"text",placeholder:"Поиск по комментариям...",class:"h-9 px-3 text-sm rounded-lg border border-input bg-background text-foreground flex-1 min-w-[200px]"},null,512),[[g,r.filters.search]])])):m("",!0),r.loading&&r.history.length===0?(n(),d("div",L," Загрузка истории статусов... ")):a.filteredHistory.length===0?(n(),d("div",A,i(r.history.length===0?"История статусов пуста":"Нет записей, соответствующих фильтрам"),1)):(n(),d("div",P,[e[11]||(e[11]=t("div",{class:"absolute left-4 top-0 bottom-0 w-0.5 bg-border"},null,-1)),t("div",M,[(n(!0),d(v,null,x(a.filteredHistory,(l,_)=>(n(),d("div",{key:l.id,class:"relative flex gap-4"},[t("div",{class:b(["absolute left-4 w-3 h-3 rounded-full border-2 border-background -translate-x-1/2",a.getStatusColor(l.status)]),style:{top:"0.5rem"}},null,2),t("div",z,[t("div",E,[t("div",F,[t("div",T,[t("span",{class:b(["px-2 py-1 text-xs font-medium rounded-md",a.getStatusBadgeClass(l.status)])},i(a.translateStatus(l.status)),3),t("span",{class:b(["px-2 py-1 text-xs font-medium rounded-md",a.getRoleBadgeClass(l.role)])},i(a.translateRole(l.role)),3)]),t("span",J,i(a.formatDate(l.created_at)),1)]),l.previous_status?(n(),d("div",G,[e[7]||(e[7]=t("span",{class:"font-medium"},"Предыдущий статус:",-1)),y(" "+i(a.translateStatus(l.previous_status)),1)])):m("",!0),a.getUserName(l)?(n(),d("div",K,[e[8]||(e[8]=t("span",{class:"font-medium"},"Изменил:",-1)),y(" "+i(a.getUserName(l)),1)])):m("",!0),l.comment?(n(),d("div",Q,[e[9]||(e[9]=t("span",{class:"font-medium text-muted-foreground"},"Комментарий:",-1)),t("p",W,i(l.comment),1)])):m("",!0),l.metadata&&Object.keys(l.metadata).length>0?(n(),d("div",X,[t("details",Y,[e[10]||(e[10]=t("summary",{class:"font-medium"},"Дополнительная информация",-1)),t("pre",Z,i(JSON.stringify(l.metadata,null,2)),1)])])):m("",!0)])])]))),128))])]))])}const ee=U(I,[["render",$],["__scopeId","data-v-d4754d19"]]),te={name:"OrderDetail",components:{OrderStatusHistory:ee},data(){return{order:null,delivery:null,payments:[],form:{},loading:!1,saving:!1,error:null}},mounted(){this.loadOrder(),this.loadDelivery(),this.loadPayments()},methods:{async loadOrder(){this.loading=!0,this.error=null;try{const o=this.$route.params.id,e=await h.getById(o);this.order=e.data,this.form={status:this.order.status||"new",payment_status:this.order.payment_status||"pending",phone:this.order.phone||"",delivery_address:this.order.delivery_address||"",delivery_time:this.order.delivery_time||"",comment:this.order.comment||"",total_amount:Number(this.order.total_amount)||0,notes:this.order.notes||""}}catch(o){this.error=o.message||"Ошибка загрузки заказа"}finally{this.loading=!1}},async loadDelivery(){try{const o=this.$route.params.id,e=await N.getByOrder(o);this.delivery=e.data}catch(o){console.log("Доставка не найдена:",o)}},async loadPayments(){try{const o=this.$route.params.id,e=await C.getByOrder(o);this.payments=e.data||[]}catch(o){console.log("Ошибка загрузки платежей:",o)}},async handleSubmit(){this.saving=!0;try{const o=this.$route.params.id;await h.update(o,this.form),await this.loadOrder(),await S.success("Заказ успешно обновлен")}catch(o){await S.error(o.message||"Ошибка обновления заказа")}finally{this.saving=!1}}}},oe={class:"order-detail-page"},re={class:"mb-6"},se={class:"flex items-center justify-between"},de={class:"text-2xl font-bold text-foreground"},ne={key:0,class:"bg-card rounded-lg border border-border p-12 text-center"},le={key:1,class:"bg-destructive/10 border border-destructive/20 rounded-lg p-4"},ie={class:"text-destructive"},ae={key:2,class:"space-y-6"},ue={class:"bg-card rounded-lg border border-border p-6"},me={class:"grid grid-cols-2 gap-4"},ge={class:"col-span-2"},pe={class:"col-span-2"},ce={class:"flex items-center gap-4 pt-4 border-t border-border"},be=["disabled"],fe={class:"bg-card rounded-lg border border-border p-6"},ve={key:0,class:"space-y-2"},xe={class:"flex items-center gap-4"},ye=["src","alt"],_e={class:"font-medium text-foreground"},he={class:"text-sm text-muted-foreground"},ke={class:"font-medium text-foreground"},we={key:1,class:"text-center py-8 text-muted-foreground"},Se={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},Ue={class:"bg-card rounded-lg border border-border p-6"},Ve={key:0,class:"space-y-2"},Ce={class:"text-sm"},Ne={class:"ml-2 font-medium text-foreground"},Oe={class:"text-sm"},Be={class:"ml-2 font-medium text-foreground"},He={key:0,class:"text-sm"},Ie={class:"ml-2 font-medium text-foreground"},je={key:1,class:"text-sm"},De={class:"ml-2 font-medium text-foreground"},Re={key:1,class:"text-center py-4 text-muted-foreground"},qe={class:"bg-card rounded-lg border border-border p-6"},Le={key:0,class:"space-y-2"},Ae={class:"text-sm"},Pe={class:"ml-2 font-medium text-foreground"},Me={class:"text-sm"},ze={class:"ml-2 font-medium text-foreground"},Ee={class:"text-sm"},Fe={class:"ml-2 font-medium text-foreground"},Te={key:1,class:"text-center py-4 text-muted-foreground"},Je={class:"bg-card rounded-lg border border-border p-6"};function Ge(o,e,p,V,r,a){const l=w("router-link"),_=w("OrderStatusHistory");return n(),d("div",oe,[t("div",re,[t("div",se,[t("div",null,[t("h1",de,"Заказ #"+i(r.order?.order_id),1),e[9]||(e[9]=t("p",{class:"text-muted-foreground mt-1"},"Детальная информация о заказе",-1))]),k(l,{to:"/orders",class:"h-10 px-4 bg-muted text-muted-foreground rounded-lg hover:bg-muted/80 inline-flex items-center"},{default:B(()=>[...e[10]||(e[10]=[y(" К списку заказов ",-1)])]),_:1})])]),r.loading&&!r.order?(n(),d("div",ne,[...e[11]||(e[11]=[t("p",{class:"text-muted-foreground"},"Загрузка заказа...",-1)])])):r.error?(n(),d("div",le,[t("p",ie,i(r.error),1)])):r.order?(n(),d("div",ae,[t("div",ue,[e[22]||(e[22]=t("h2",{class:"text-lg font-semibold text-foreground mb-4 border-b border-border pb-2"},"Основная информация",-1)),t("form",{onSubmit:e[8]||(e[8]=H((...s)=>a.handleSubmit&&a.handleSubmit(...s),["prevent"])),class:"space-y-4"},[t("div",me,[t("div",null,[e[13]||(e[13]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Статус заказа",-1)),u(t("select",{"onUpdate:modelValue":e[0]||(e[0]=s=>r.form.status=s),class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},[...e[12]||(e[12]=[f('<option value="new">Новый</option><option value="accepted">Принят</option><option value="sent_to_kitchen">Отправлен на кухню</option><option value="kitchen_accepted">Принят кухней</option><option value="preparing">Готовится</option><option value="ready_for_delivery">Готов к доставке</option><option value="courier_assigned">Курьер назначен</option><option value="in_transit">В пути</option><option value="delivered">Доставлен</option><option value="cancelled">Отменен</option>',10)])],512),[[c,r.form.status]])]),t("div",null,[e[15]||(e[15]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Статус оплаты",-1)),u(t("select",{"onUpdate:modelValue":e[1]||(e[1]=s=>r.form.payment_status=s),class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},[...e[14]||(e[14]=[t("option",{value:"pending"},"Ожидает",-1),t("option",{value:"succeeded"},"Оплачен",-1),t("option",{value:"failed"},"Ошибка",-1),t("option",{value:"cancelled"},"Отменен",-1)])],512),[[c,r.form.payment_status]])]),t("div",null,[e[16]||(e[16]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Телефон",-1)),u(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>r.form.phone=s),type:"text",required:"",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,512),[[g,r.form.phone]])]),t("div",null,[e[17]||(e[17]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Общая сумма",-1)),u(t("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>r.form.total_amount=s),type:"number",step:"0.01",required:"",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,512),[[g,r.form.total_amount,void 0,{number:!0}]])]),t("div",ge,[e[18]||(e[18]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Адрес доставки",-1)),u(t("textarea",{"onUpdate:modelValue":e[4]||(e[4]=s=>r.form.delivery_address=s),rows:"2",required:"",class:"w-full px-3 py-2 rounded-lg border border-input bg-background"},null,512),[[g,r.form.delivery_address]])]),t("div",null,[e[19]||(e[19]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Время доставки",-1)),u(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>r.form.delivery_time=s),type:"text",required:"",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,512),[[g,r.form.delivery_time]])]),t("div",null,[e[20]||(e[20]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Комментарий",-1)),u(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>r.form.comment=s),type:"text",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,512),[[g,r.form.comment]])]),t("div",pe,[e[21]||(e[21]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Внутренние заметки",-1)),u(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=s=>r.form.notes=s),rows:"3",class:"w-full px-3 py-2 rounded-lg border border-input bg-background"},null,512),[[g,r.form.notes]])])]),t("div",ce,[t("button",{type:"submit",disabled:r.saving,class:"h-10 px-6 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 disabled:opacity-50"},i(r.saving?"Сохранение...":"Сохранить изменения"),9,be)])],32)]),t("div",fe,[e[23]||(e[23]=t("h2",{class:"text-lg font-semibold text-foreground mb-4 border-b border-border pb-2"},"Товары",-1)),r.order.items&&r.order.items.length>0?(n(),d("div",ve,[(n(!0),d(v,null,x(r.order.items,s=>(n(),d("div",{key:s.id,class:"flex items-center justify-between p-4 bg-muted/30 rounded-lg"},[t("div",xe,[s.product_image?(n(),d("img",{key:0,src:s.product_image,alt:s.product_name,class:"w-16 h-16 object-cover rounded-lg"},null,8,ye)):m("",!0),t("div",null,[t("div",_e,i(s.product_name),1),t("div",he,i(s.quantity)+" шт. × "+i(Number(s.unit_price).toLocaleString("ru-RU"))+" ₽ ",1)])]),t("div",ke,i(Number(s.total).toLocaleString("ru-RU"))+" ₽ ",1)]))),128))])):(n(),d("div",we," Товары не найдены "))]),t("div",Se,[t("div",Ue,[e[28]||(e[28]=t("h2",{class:"text-lg font-semibold text-foreground mb-4 border-b border-border pb-2"},"Доставка",-1)),r.delivery?(n(),d("div",Ve,[t("div",Ce,[e[24]||(e[24]=t("span",{class:"text-muted-foreground"},"Статус:",-1)),t("span",Ne,i(r.delivery.status),1)]),t("div",Oe,[e[25]||(e[25]=t("span",{class:"text-muted-foreground"},"Тип:",-1)),t("span",Be,i(r.delivery.delivery_type),1)]),r.delivery.courier_name?(n(),d("div",He,[e[26]||(e[26]=t("span",{class:"text-muted-foreground"},"Курьер:",-1)),t("span",Ie,i(r.delivery.courier_name),1)])):m("",!0),r.delivery.tracking_number?(n(),d("div",je,[e[27]||(e[27]=t("span",{class:"text-muted-foreground"},"Трек-номер:",-1)),t("span",De,i(r.delivery.tracking_number),1)])):m("",!0)])):(n(),d("div",Re," Доставка не создана "))]),t("div",qe,[e[32]||(e[32]=t("h2",{class:"text-lg font-semibold text-foreground mb-4 border-b border-border pb-2"},"Платежи",-1)),r.payments&&r.payments.length>0?(n(),d("div",Le,[(n(!0),d(v,null,x(r.payments,s=>(n(),d("div",{key:s.id,class:"p-3 bg-muted/30 rounded-lg"},[t("div",Ae,[e[29]||(e[29]=t("span",{class:"text-muted-foreground"},"Сумма:",-1)),t("span",Pe,i(Number(s.amount).toLocaleString("ru-RU"))+" ₽ ",1)]),t("div",Me,[e[30]||(e[30]=t("span",{class:"text-muted-foreground"},"Статус:",-1)),t("span",ze,i(s.status),1)]),t("div",Ee,[e[31]||(e[31]=t("span",{class:"text-muted-foreground"},"Метод:",-1)),t("span",Fe,i(s.payment_method),1)])]))),128))])):(n(),d("div",Te," Платежей нет "))]),t("div",Je,[k(_,{"order-id":r.order.id},null,8,["order-id"])])])])):m("",!0)])}const Ye=U(te,[["render",Ge]]);export{Ye as default};
