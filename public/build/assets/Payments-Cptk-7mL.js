import{f as m}from"./api-DAGhxNrk.js";import{s as a}from"./swal-C5DxUZ5S.js";import{_ as w,c as l,o as u,a as e,b as c,f as g,g as b,r as k,d as f,v as _,C as h,A as y,t as d,F as P,q as R,e as v,p as F}from"./admin-CWNSFvzy.js";import"./sweetalert2.esm.all-C0u8rGqG.js";const C={name:"Payments",data(){return{payments:[],loading:!1,error:null,searchQuery:"",statusFilter:"",methodFilter:"",sortBy:"created_at",showRefundModal:!1,selectedPaymentForRefund:null,refundAmount:null,refunding:!1}},computed:{filteredPayments(){let s=[...this.payments];if(this.searchQuery){const t=this.searchQuery.toLowerCase();s=s.filter(n=>n.transaction_id&&n.transaction_id.toLowerCase().includes(t)||n.order?.order_id&&n.order.order_id.toLowerCase().includes(t))}return this.statusFilter&&(s=s.filter(t=>t.status===this.statusFilter)),this.methodFilter&&(s=s.filter(t=>t.payment_method===this.methodFilter)),s.sort((t,n)=>this.sortBy==="created_at"?new Date(n.created_at)-new Date(t.created_at):this.sortBy==="amount"?Number(n.amount)-Number(t.amount):this.sortBy==="status"?t.status.localeCompare(n.status):0),s}},mounted(){this.loadPayments()},methods:{async loadPayments(){this.loading=!0,this.error=null;try{const s=await m.getAll();this.payments=s.data?.data||s.data||[]}catch(s){this.error=s.message||"Ошибка загрузки платежей"}finally{this.loading=!1}},async handleStatusChange(s,t){try{await m.updateStatus(s,t),await this.loadPayments()}catch(n){await a.error(n.message||"Ошибка изменения статуса"),await this.loadPayments()}},handleRefund(s){this.selectedPaymentForRefund=s,this.refundAmount=null,this.showRefundModal=!0},async confirmRefund(){if(this.selectedPaymentForRefund){this.refunding=!0;try{await m.refund(this.selectedPaymentForRefund.id,this.refundAmount||null),this.showRefundModal=!1,this.selectedPaymentForRefund=null,this.refundAmount=null,await this.loadPayments(),await a.success("Возврат платежа выполнен")}catch(s){await a.error(s.message||"Ошибка возврата платежа")}finally{this.refunding=!1}}},async handleDelete(s){if((await a.confirm(`Вы уверены, что хотите удалить платеж для заказа #${s.order?.order_id||s.order_id}?`,"Удаление платежа","Удалить","Отмена")).isConfirmed)try{await m.delete(s.id),await this.loadPayments(),await a.success("Платеж успешно удален")}catch(n){await a.error(n.message||"Ошибка удаления платежа")}},getPaymentMethodLabel(s){return{card:"Карта",cash:"Наличные",online:"Онлайн",bank_transfer:"Банковский перевод",other:"Другое"}[s]||s},getStatusClass(s){return{pending:"bg-yellow-100 text-yellow-800",processing:"bg-blue-100 text-blue-800",succeeded:"bg-green-100 text-green-800",failed:"bg-red-100 text-red-800",refunded:"bg-gray-100 text-gray-800",partially_refunded:"bg-orange-100 text-orange-800",cancelled:"bg-red-100 text-red-800"}[s]||""},formatDate(s){return s?new Date(s).toLocaleDateString("ru-RU"):"—"}}},D={class:"payments-page"},S={class:"mb-6 flex items-center justify-between"},A={class:"bg-card rounded-lg border border-border p-4 mb-6"},L={class:"flex gap-4 items-end flex-wrap"},V={class:"flex-1 min-w-[200px]"},B={key:0,class:"bg-card rounded-lg border border-border p-12 text-center"},M={key:1,class:"bg-destructive/10 border border-destructive/20 rounded-lg p-4"},N={class:"text-destructive"},U={key:2,class:"bg-card rounded-lg border border-border overflow-hidden"},Q={class:"w-full"},j={class:"divide-y divide-border"},T={class:"px-6 py-4"},q={class:"px-6 py-4"},z={class:"text-sm font-medium text-foreground"},I={key:0,class:"text-xs text-muted-foreground"},E={class:"px-6 py-4"},G={class:"text-sm text-foreground"},H={class:"px-6 py-4"},J={class:"text-sm text-muted-foreground"},K={class:"px-6 py-4"},O=["value","onChange"],W={class:"px-6 py-4"},X={class:"text-xs text-muted-foreground font-mono"},Y={class:"px-6 py-4"},Z={class:"text-sm text-foreground"},$={class:"px-6 py-4 text-right"},ee={class:"flex items-center justify-end gap-2"},te=["onClick"],oe=["onClick"],se={key:0,class:"p-12 text-center"},re={key:3,class:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center"},ne={class:"bg-card rounded-lg border border-border p-6 max-w-md w-full"},de={class:"space-y-4"},le=["max"],ue={key:0,class:"mt-1 text-xs text-muted-foreground"},ie={class:"flex gap-4"},ae=["disabled"];function ce(s,t,n,fe,r,i){const p=k("router-link");return u(),l("div",D,[e("div",S,[t[8]||(t[8]=e("div",null,[e("h1",{class:"text-2xl font-bold text-foreground"},"Платежи"),e("p",{class:"text-muted-foreground mt-1"},"Управление платежами")],-1)),g(p,{to:"/payments/create",class:"h-10 px-4 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 inline-flex items-center gap-2"},{default:b(()=>[...t[7]||(t[7]=[e("span",null,"+",-1),e("span",null,"Создать платеж",-1)])]),_:1})]),e("div",A,[e("div",L,[e("div",V,[t[9]||(t[9]=e("label",{class:"text-sm font-medium text-foreground mb-1 block"},"Поиск",-1)),f(e("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>r.searchQuery=o),type:"text",placeholder:"Поиск по transaction_id, номеру заказа...",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,512),[[_,r.searchQuery]])]),e("div",null,[t[11]||(t[11]=e("label",{class:"text-sm font-medium text-foreground mb-1 block"},"Статус",-1)),f(e("select",{"onUpdate:modelValue":t[1]||(t[1]=o=>r.statusFilter=o),class:"h-10 px-3 rounded-lg border border-input bg-background"},[...t[10]||(t[10]=[y('<option value="">Все</option><option value="pending">Ожидает</option><option value="processing">Обрабатывается</option><option value="succeeded">Успешен</option><option value="failed">Ошибка</option><option value="refunded">Возвращен</option><option value="partially_refunded">Частично возвращен</option><option value="cancelled">Отменен</option>',8)])],512),[[h,r.statusFilter]])]),e("div",null,[t[13]||(t[13]=e("label",{class:"text-sm font-medium text-foreground mb-1 block"},"Метод",-1)),f(e("select",{"onUpdate:modelValue":t[2]||(t[2]=o=>r.methodFilter=o),class:"h-10 px-3 rounded-lg border border-input bg-background"},[...t[12]||(t[12]=[y('<option value="">Все</option><option value="card">Карта</option><option value="cash">Наличные</option><option value="online">Онлайн</option><option value="bank_transfer">Банковский перевод</option><option value="other">Другое</option>',6)])],512),[[h,r.methodFilter]])]),e("div",null,[t[15]||(t[15]=e("label",{class:"text-sm font-medium text-foreground mb-1 block"},"Сортировка",-1)),f(e("select",{"onUpdate:modelValue":t[3]||(t[3]=o=>r.sortBy=o),class:"h-10 px-3 rounded-lg border border-input bg-background"},[...t[14]||(t[14]=[e("option",{value:"created_at"},"По дате",-1),e("option",{value:"amount"},"По сумме",-1),e("option",{value:"status"},"По статусу",-1)])],512),[[h,r.sortBy]])])])]),r.loading?(u(),l("div",B,[...t[16]||(t[16]=[e("p",{class:"text-muted-foreground"},"Загрузка платежей...",-1)])])):r.error?(u(),l("div",M,[e("p",N,d(r.error),1)])):(u(),l("div",U,[e("table",Q,[t[19]||(t[19]=e("thead",{class:"bg-muted/50"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Заказ"),e("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Сумма"),e("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Метод"),e("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Провайдер"),e("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Статус"),e("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Transaction ID"),e("th",{class:"px-6 py-3 text-left text-sm font-medium text-foreground"},"Дата"),e("th",{class:"px-6 py-3 text-right text-sm font-medium text-foreground"},"Действия")])],-1)),e("tbody",j,[(u(!0),l(P,null,R(i.filteredPayments,o=>(u(),l("tr",{key:o.id},[e("td",T,[g(p,{to:`/orders/${o.order_id}`,class:"text-sm font-medium text-accent hover:underline"},{default:b(()=>[v(" #"+d(o.order?.order_id||o.order_id),1)]),_:2},1032,["to"])]),e("td",q,[e("div",z,d(Number(o.amount).toLocaleString("ru-RU"))+" "+d(o.currency||"₽"),1),o.refunded_amount>0?(u(),l("div",I," Возвращено: "+d(Number(o.refunded_amount).toLocaleString("ru-RU"))+" "+d(o.currency||"₽"),1)):c("",!0)]),e("td",E,[e("span",G,d(i.getPaymentMethodLabel(o.payment_method)),1)]),e("td",H,[e("span",J,d(o.payment_provider||"—"),1)]),e("td",K,[e("select",{value:o.status,onChange:x=>i.handleStatusChange(o.id,x.target.value),class:F(["text-xs px-2 py-1 rounded border border-input bg-background",i.getStatusClass(o.status)])},[...t[17]||(t[17]=[y('<option value="pending">Ожидает</option><option value="processing">Обрабатывается</option><option value="succeeded">Успешен</option><option value="failed">Ошибка</option><option value="refunded">Возвращен</option><option value="partially_refunded">Частично возвращен</option><option value="cancelled">Отменен</option>',7)])],42,O)]),e("td",W,[e("span",X,d(o.transaction_id||"—"),1)]),e("td",Y,[e("span",Z,d(i.formatDate(o.created_at)),1)]),e("td",$,[e("div",ee,[g(p,{to:`/payments/${o.id}/edit`,class:"h-8 px-3 text-sm bg-accent/10 text-accent rounded-lg hover:bg-accent/20"},{default:b(()=>[...t[18]||(t[18]=[v(" Редактировать ",-1)])]),_:1},8,["to"]),o.status==="succeeded"&&o.refunded_amount<o.amount?(u(),l("button",{key:0,onClick:x=>i.handleRefund(o),class:"h-8 px-3 text-sm bg-orange-100 text-orange-800 rounded-lg hover:bg-orange-200"}," Возврат ",8,te)):c("",!0),e("button",{onClick:x=>i.handleDelete(o),class:"h-8 px-3 text-sm bg-destructive/10 text-destructive rounded-lg hover:bg-destructive/20"}," Удалить ",8,oe)])])]))),128))])]),i.filteredPayments.length===0?(u(),l("div",se,[...t[20]||(t[20]=[e("p",{class:"text-muted-foreground"},"Платежи не найдены",-1)])])):c("",!0)])),r.showRefundModal?(u(),l("div",re,[e("div",ne,[t[22]||(t[22]=e("h2",{class:"text-xl font-bold text-foreground mb-4"},"Возврат платежа",-1)),e("div",de,[e("div",null,[t[21]||(t[21]=e("label",{class:"block text-sm font-medium text-foreground mb-2"},[v(" Сумма возврата "),e("span",{class:"text-muted-foreground text-xs"},"(оставьте пустым для полного возврата)")],-1)),f(e("input",{"onUpdate:modelValue":t[4]||(t[4]=o=>r.refundAmount=o),type:"number",step:"0.01",min:.01,max:r.selectedPaymentForRefund?r.selectedPaymentForRefund.amount-r.selectedPaymentForRefund.refunded_amount:0,placeholder:"Полный возврат",class:"w-full h-10 px-3 rounded-lg border border-input bg-background"},null,8,le),[[_,r.refundAmount,void 0,{number:!0}]]),r.selectedPaymentForRefund?(u(),l("p",ue," Доступно для возврата: "+d((r.selectedPaymentForRefund.amount-r.selectedPaymentForRefund.refunded_amount).toLocaleString("ru-RU"))+" "+d(r.selectedPaymentForRefund.currency||"₽"),1)):c("",!0)]),e("div",ie,[e("button",{onClick:t[5]||(t[5]=(...o)=>i.confirmRefund&&i.confirmRefund(...o)),disabled:r.refunding,class:"flex-1 h-10 px-4 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50"},d(r.refunding?"Возврат...":"Вернуть"),9,ae),e("button",{onClick:t[6]||(t[6]=o=>{r.showRefundModal=!1,r.selectedPaymentForRefund=null,r.refundAmount=null}),class:"flex-1 h-10 px-4 bg-muted text-muted-foreground rounded-lg hover:bg-muted/80"}," Отмена ")])])])])):c("",!0)])}const be=w(C,[["render",ce]]);export{be as default};
