# Решение проблемы 403 ошибки Яндекс Suggest API

## Проблема

В логах видна ошибка:
```
[2026-01-12 15:15:37] prod.ERROR: Yandex Suggest API error {"status":403,"body":""}
```

**Статус 403 (Forbidden)** означает, что доступ к API запрещен.

---

## Возможные причины

### 1. API ключ не имеет доступа к Suggest API

**Проблема:** Ключ для Геокодера может не включать доступ к Suggest API.

**Решение:**
- Проверьте в личном кабинете Яндекс (https://developer.tech.yandex.ru/)
- Убедитесь, что в проекте включен доступ к "API подсказок" или "Suggest API"
- Возможно, нужен отдельный ключ для Suggest API

### 2. Домен не разрешен в настройках ключа

**Проблема:** В настройках проекта указан другой домен.

**Решение:**
- Зайдите в настройки проекта на https://developer.tech.yandex.ru/
- Проверьте список разрешенных доменов
- Добавьте `neekloai.ru` в список разрешенных доменов

### 3. Неверный endpoint или формат запроса

**Проблема:** Возможно, используется неправильный URL или формат.

**Текущий endpoint:** `https://suggest-maps.yandex.ru/v1/suggest`

**Альтернативы:**
- Проверьте документацию: https://yandex.com/dev/maps/jsapi/doc/2.1/ref/reference/suggestView.html
- Возможно, нужен другой endpoint для HTTP API

### 4. Превышен лимит или требуется коммерческий договор

**Проблема:** Suggest API может требовать коммерческий договор.

**Решение:**
- Проверьте тарифный план в личном кабинете
- Для коммерческого использования может потребоваться договор

---

## Решения

### Решение 1: Использовать JavaScript API SuggestView (рекомендуется)

Вместо HTTP API можно использовать JavaScript API, который работает через браузер:

```javascript
// На frontend
ymaps.ready(function () {
    var suggestView = new ymaps.SuggestView('address-input', {
        boundedBy: [[56.7, 60.5], [56.9, 60.7]], // Екатеринбург
        results: 10
    });
    
    suggestView.events.add('select', function (e) {
        var selected = e.get('item').value;
        // Обработка выбранного адреса
    });
});
```

**Преимущества:**
- Не требует backend запросов
- Работает напрямую с браузера
- Использует тот же API ключ

**Недостатки:**
- Нужно подключить скрипт Яндекс.Карт
- Ключ будет виден на frontend (но это нормально для JS API)

### Решение 2: Использовать альтернативный сервис (DaData)

Если Яндекс Suggest API недоступен, можно использовать DaData:

- Бесплатный лимит: 10,000 запросов/день
- Специализированный API для адресов
- Лучшая точность

### Решение 3: Использовать только Геокодер для валидации

Вместо подсказок можно:
- Разрешить пользователю вводить адрес вручную
- Валидировать адрес через Геокодер (который работает)
- Показывать ошибку, если адрес не найден

---

## Проверка текущей ситуации

### Шаг 1: Проверьте API ключ

```bash
php artisan tinker
```

```php
$settings = \App\Models\DeliverySetting::getSettings();
echo "API Key: " . substr($settings->yandex_geocoder_api_key, 0, 10) . "...\n";
echo "Length: " . strlen($settings->yandex_geocoder_api_key) . "\n";
```

### Шаг 2: Проверьте доступность Suggest API

Попробуйте прямой запрос:

```bash
curl "https://suggest-maps.yandex.ru/v1/suggest?apikey=ВАШ_КЛЮЧ&text=Ленина&lang=ru_RU&types=address"
```

Если получаете 403 - проблема с ключом или доступом.

### Шаг 3: Проверьте настройки проекта

1. Зайдите на https://developer.tech.yandex.ru/
2. Откройте ваш проект
3. Проверьте:
   - Разрешенные домены (должен быть `neekloai.ru`)
   - Включенные API (должен быть Suggest API)
   - Тарифный план

---

## Временное решение

Пока проблема не решена, можно:

1. **Отключить подсказки** - пользователь вводит адрес вручную
2. **Использовать только валидацию** - проверять адрес после ввода
3. **Показать сообщение пользователю** - объяснить, что подсказки временно недоступны

---

## Рекомендация

**Лучшее решение:** Использовать JavaScript API SuggestView на frontend вместо HTTP API на backend.

Это:
- ✅ Не требует backend запросов
- ✅ Работает с тем же ключом
- ✅ Более надежно
- ✅ Меньше нагрузка на сервер

