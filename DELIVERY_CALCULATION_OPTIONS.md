# Варианты реализации расчета доставки по расстоянию

## Требования
- Стоимость доставки: 300 / 500 / 800 / 1000 ₽ в зависимости от расстояния
- Валидация адреса при оформлении
- Расчет от точки начала доставки до адреса клиента

---

## Вариант 1: Яндекс.Геокодер + Формула Хаверсина ⭐ (Простой)

### Как работает:
1. Геокодинг адреса клиента через Яндекс.Геокодер API
2. Расчет расстояния по формуле Хаверсина (координаты → км)
3. Тарификация по зонам расстояния

### Плюсы:
- ✅ Бесплатный геокодинг (есть лимиты)
- ✅ Быстро
- ✅ Не требует сложных зависимостей

### Минусы:
- ❌ Расстояние по прямой (не по дорогам)
- ❌ Может быть неточно в городе
- ❌ Нужен API ключ Яндекса

### Пример структуры:
```php
// Конфигурация зон
300 ₽ - до 3 км
500 ₽ - до 7 км  
800 ₽ - до 12 км
1000 ₽ - свыше 12 км
```

---

## Вариант 2: Яндекс.Маршрутизатор API ⭐⭐ (Точный)

### Как работает:
1. Геокодинг адреса
2. Расчет маршрута через Яндекс.Маршрутизатор API
3. Получение расстояния по дорогам
4. Тарификация

### Плюсы:
- ✅ Точное расстояние по дорогам
- ✅ Учитывает логистику
- ✅ Можно использовать время в пути

### Минусы:
- ❌ Платный API (но недорогой)
- ❌ Медленнее
- ❌ Нужен API ключ

---

## Вариант 3: Зоны доставки (Без API) ⭐⭐⭐

### Как работает:
1. Предопределенные зоны (районы, улицы)
2. Клиент выбирает зону или вводит адрес
3. Поиск адреса в зонах
4. Тарификация по зоне

### Плюсы:
- ✅ Не нужны внешние API
- ✅ Быстро
- ✅ Полный контроль
- ✅ Не зависит от интернета

### Минусы:
- ❌ Требует ручного создания зон
- ❌ Менее гибко
- ❌ Нужно поддерживать список зон

---

## Вариант 4: Google Maps API

### Как работает:
1. Геокодинг через Google Geocoding API
2. Расчет расстояния через Distance Matrix API
3. Тарификация

### Плюсы:
- ✅ Точные данные
- ✅ Хорошее покрытие
- ✅ Подробная документация

### Минусы:
- ❌ Платный (но есть бесплатный лимит)
- ❌ Может быть дороже Яндекса

---

## Вариант 5: Гибридный подход ⭐⭐⭐⭐ (РЕКОМЕНДУЮ)

### Как работает:
1. Яндекс.Геокодер для валидации и координат
2. Формула Хаверсина для быстрого расчета
3. Зоны для точной тарификации
4. Возможность добавления Яндекс.Маршрутизатора для дальних адресов

### Структура:
```php
// Настройки
- Точка начала доставки (координаты)
- Зоны доставки (расстояние → цена)
- Флаг использования маршрутизатора для дальних адресов (>10 км)
```

### Плюсы:
- ✅ Баланс скорости и точности
- ✅ Гибкость настройки
- ✅ Можно начать просто и усложнить
- ✅ Минимальные затраты

### Минусы:
- ❌ Более сложная реализация

---

## Рекомендация

**Начать с Варианта 5 (Гибридный)**, по шагам:
1. Сначала простой вариант: Яндекс.Геокодер + формула расстояния
2. Добавить валидацию адреса
3. При необходимости - добавить Яндекс.Маршрутизатор для дальних адресов

---

## Пример API структуры

### Backend Endpoint
```
POST /api/v1/delivery/calculate
{
  "address": "г. Екатеринбург, ул. Ленина, 1"
}

Response:
{
  "valid": true,
  "address": "г. Екатеринбург, ул. Ленина, 1",
  "coordinates": {
    "lat": 56.8431,
    "lon": 60.6454
  },
  "distance": 5.2, // км
  "cost": 500, // ₽
  "zone": "до 7 км"
}
```

### Frontend интеграция
- При вводе адреса → debounce → валидация
- Показ стоимости доставки
- Блокировка оформления при невалидном адресе

---

## Необходимые изменения

1. **Backend:**
   - Сервис расчета доставки
   - API endpoint для расчета
   - Конфигурация зон доставки
   - Настройка точки начала доставки

2. **Frontend:**
   - Валидация адреса в CheckoutPage
   - Отображение стоимости доставки
   - Обработка ошибок валидации

3. **База данных:**
   - Возможно сохранение координат адреса
   - История расчетов (опционально)

