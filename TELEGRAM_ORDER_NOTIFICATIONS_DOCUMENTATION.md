# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –±–æ—Ç–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞

## –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞ –≤ —Å–∏—Å—Ç–µ–º–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–µ–µ:

1. **–ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑** —á–µ—Ä–µ–∑ API ‚Üí –∑–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `new`
2. **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞–∫–∞–∑–µ –∏ –∫–Ω–æ–ø–∫–∞–º–∏ "‚úÖ –ü—Ä–∏–Ω—è—Ç—å" / "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"
3. **–ö–ª–∏–µ–Ω—Ç –ù–ï –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** —Å—Ä–∞–∑—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
4. **–ü–æ—Å–ª–µ –ø—Ä–∏–Ω—è—Ç–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º:**
   - –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –º–µ–Ω—è–µ—Ç—Å—è: `new` ‚Üí `accepted`
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (–¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏)
   - **–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:** "‚úÖ –í–∞—à –∑–∞–∫–∞–∑ #ORD-... –ø—Ä–∏–Ω—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É"
5. **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞** –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è)

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è, –∞ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞](#—Ç–æ—á–∫–∞-–≤—Ö–æ–¥–∞-—Å–æ–∑–¥–∞–Ω–∏–µ-–∑–∞–∫–∞–∑–∞)
3. [–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É](#—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É)
4. [–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É](#—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ-–∫–ª–∏–µ–Ω—Ç—É)
5. [–õ–æ–≥–∏—á–µ—Å–∫–∞—è —Ü–µ–ø–æ—á–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏](#–ª–æ–≥–∏—á–µ—Å–∫–∞—è-—Ü–µ–ø–æ—á–∫–∞-–æ–±—Ä–∞–±–æ—Ç–∫–∏)
6. [–§–æ—Ä–º–∞—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π](#—Ñ–æ—Ä–º–∞—Ç—ã-—Å–æ–æ–±—â–µ–Ω–∏–π)
7. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–¥–µ–π—Å—Ç–≤–∏–π-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
8. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–ø—Ä–∏—á–∏–Ω—ã-–æ—Ç–º–µ–Ω—ã-–∑–∞–∫–∞–∑–∞)
9. [–û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–º](#–æ—Ç–º–µ–Ω–∞-–∑–∞–∫–∞–∑–∞-–∫–ª–∏–µ–Ω—Ç–æ–º)
10. [–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Ä–æ–ª–µ–π: –ö—É—Ö–Ω—è –∏ –ö—É—Ä—å–µ—Ä](#–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ-—Ä–æ–ª–µ–π-–∫—É—Ö–Ω—è-–∏-–∫—É—Ä—å–µ—Ä)
11. [–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫—É—Ö–Ω–µ –∏ –∫—É—Ä—å–µ—Ä–∞–º (–¥–µ—Ç–∞–ª–∏)](#—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è-–∫—É—Ö–Ω–µ-–∏-–∫—É—Ä—å–µ—Ä–∞–º-–¥–µ—Ç–∞–ª–∏)
12. [–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è](#–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
13. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏](#—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏)
14. [–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å](#—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏-–∏-–∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å)
15. [–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#–¥–∏–∞–≥—Ä–∞–º–º–∞-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
16. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
17. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)
18. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ-–¥–µ—Ç–∞–ª–∏)
19. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

---

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∑–∞–∫–∞–∑–∞—Ö –≤ Telegram –±–æ—Ç–µ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

- **OrderNotificationService** (`app/Services/Order/OrderNotificationService.php`) - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **TelegramService** (`app/Services/TelegramService.php`) - —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram Bot API
- **OrderNotification** (`app/Models/OrderNotification.php`) - –º–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ë–î
- **SendOrderNotificationJob** (`app/Jobs/SendOrderNotificationJob.php`) - Job –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **OrderController** (`app/Http/Controllers/Api/v1/OrderController.php`) - –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤
- **BotController** (`app/Http/Controllers/Api/BotController.php`) - –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback'–æ–≤ –æ—Ç –∫–Ω–æ–ø–æ–∫

---

## –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞

### 1.1. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ API

**–§–∞–π–ª:** `app/Http/Controllers/Api/v1/OrderController.php`  
**–ú–µ—Ç–æ–¥:** `store(Request $request)`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞
2. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∑–∞–∫–∞–∑–∞ –≤ –ë–î —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `new` (Order::STATUS_NEW)
3. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞–∫–∞–∑–∞ (OrderItem)
4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
5. **–í—ã–∑–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:** `$this->orderNotificationService->notifyAdminNewOrder($order)`

**–ö–æ–¥:**
```php
// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ –Ω–æ–≤–æ–º –∑–∞–∫–∞–∑–µ
try {
    Log::info('Attempting to notify admin about new order', [
        'order_id' => $order->id,
        'order_order_id' => $order->order_id,
        'bot_id' => $order->bot_id,
    ]);
    
    $notified = $this->orderNotificationService->notifyAdminNewOrder($order);
    
    if ($notified) {
        Log::info('Order created and admin notified', [
            'order_id' => $order->id,
            'order_order_id' => $order->order_id,
            'status' => $order->status, // –î–æ–ª–∂–µ–Ω –±—ã—Ç—å 'new'
        ]);
    } else {
        Log::warning('Order created but admin notification failed', [
            'order_id' => $order->id,
            'order_order_id' => $order->order_id,
            'bot_id' => $order->bot_id,
        ]);
    }
} catch (\Exception $e) {
    Log::error('Error notifying admin about new order: ' . $e->getMessage());
}
```

**–í–∞–∂–Ω–æ:** 
- –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `new`, –∞ –Ω–µ `accepted`
- –ö–ª–∏–µ–Ω—Ç –ù–ï –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
- –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–∏–º–µ—Ç –∑–∞–∫–∞–∑

---

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É

### 2.1. –ú–µ—Ç–æ–¥ `notifyAdminNewOrder()`

**–§–∞–π–ª:** `app/Services/Order/OrderNotificationService.php`  
**–ú–µ—Ç–æ–¥:** `notifyAdminNewOrder(Order $order): bool`

### 2.2. –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

#### –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –±–æ—Ç–∞
```php
$bot = $order->bot;
if (!$bot || !$bot->token) {
    Log::warning('Bot not found for order notification', ['order_id' => $order->id]);
    return false;
}
```

#### –®–∞–≥ 2: –ü–æ–∏—Å–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
```php
$admins = TelegramUser::where('bot_id', $bot->id)
    ->where('role', TelegramUser::ROLE_ADMIN)
    ->where('is_blocked', false)
    ->get();
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞:**
- `bot_id` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –±–æ—Ç–æ–º –∑–∞–∫–∞–∑–∞
- `role = 'admin'` (TelegramUser::ROLE_ADMIN)
- `is_blocked = false`

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```php
Log::info('Admin notification check', [
    'order_id' => $order->id,
    'bot_id' => $bot->id,
    'admins_count' => $admins->count(),
    'admin_ids' => $admins->pluck('id')->toArray(),
    'admin_telegram_ids' => $admins->pluck('telegram_id')->toArray(),
]);
```

#### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
```php
if ($admins->isEmpty()) {
    Log::warning('No admins found for order notification', [
        'order_id' => $order->id,
        'bot_id' => $bot->id,
    ]);
    return false;
}
```

#### –®–∞–≥ 4: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
```php
$message = $this->formatAdminNewOrderMessage($order);
```

**–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**
```
üÜï –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #ORD-20260126-328

üë§ –ö–ª–∏–µ–Ω—Ç: –ò–≥–æ—Ä—å
üìû –¢–µ–ª–µ—Ñ–æ–Ω: 79996371182
üìç –ê–¥—Ä–µ—Å: –°–∞–º–æ–≤—ã–≤–æ–∑
üïê –í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏: 26 —è–Ω–≤–∞—Ä—è, 16:00-17:00
üí∞ –°—É–º–º–∞: 14.94 ‚ÇΩ

üì¶ –¢–æ–≤–∞—Ä—ã:
‚Ä¢ –¢–µ—Å—Ç √ó 3 = 14.94 ‚ÇΩ

üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
```

#### –®–∞–≥ 5: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –∫–Ω–æ–ø–∫–∞–º–∏
```php
$keyboard = [
    'inline_keyboard' => [
        [
            [
                'text' => '‚úÖ –ü—Ä–∏–Ω—è—Ç—å',
                'callback_data' => "order_admin_action:{$order->id}:accept"
            ],
            [
                'text' => '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å',
                'callback_data' => "order_admin_action:{$order->id}:cancel"
            ]
        ]
    ]
];
```

#### –®–∞–≥ 6: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∂–¥–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
```php
foreach ($admins as $admin) {
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
    $result = $this->telegramService->sendMessage(
        $bot->token,
        $admin->telegram_id,
        $message,
        ['reply_markup' => json_encode($keyboard)]
    );
    
    if ($result['success'] ?? false) {
        $messageId = $result['data']['message_id'] ?? null;
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ë–î
        if ($messageId) {
            $this->saveNotification(
                $order,
                $admin,
                $messageId,
                $admin->telegram_id,
                OrderNotification::TYPE_ADMIN_NEW,
                now()->addMinutes(5) // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
            );
        }
    }
}
```

### 2.3. –ß—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä

**–°–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram:**
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ
- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏ —Ü–µ–Ω–∞–º–∏
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –î–≤–µ –∫–Ω–æ–ø–∫–∏: "‚úÖ –ü—Ä–∏–Ω—è—Ç—å" –∏ "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ** (–Ω–µ —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å) –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
- –ö–∞–∂–¥—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î —Å —Ç–∏–ø–æ–º `admin_new`
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç (expires_at)

---

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É

### 3.1. –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ?

**–í–∞–∂–Ω–æ:** –ö–ª–∏–µ–Ω—Ç –ù–ï –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞!

–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∂–º–µ—Ç –∫–Ω–æ–ø–∫—É "‚úÖ –ü—Ä–∏–Ω—è—Ç—å".

### 3.2. –ú–µ—Ç–æ–¥ `notifyClientStatusChange()`

**–§–∞–π–ª:** `app/Services/Order/OrderNotificationService.php`  
**–ú–µ—Ç–æ–¥:** `notifyClientStatusChange(Order $order, string $status, array $details = []): bool`

**–í—ã–∑—ã–≤–∞–µ—Ç—Å—è:**
- –ü–æ—Å–ª–µ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º (—Å—Ç–∞—Ç—É—Å `accepted`)
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ (–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –∫—É—Ö–Ω—é, –≥–æ—Ç–æ–≤–∏—Ç—Å—è, –≥–æ—Ç–æ–≤ –∫ –¥–æ—Å—Ç–∞–≤–∫–µ, –≤ –ø—É—Ç–∏, –¥–æ—Å—Ç–∞–≤–ª–µ–Ω, –æ—Ç–º–µ–Ω–µ–Ω)

### 3.3. –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É

#### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π
```php
$bot = $order->bot;
if (!$bot || !$bot->token || !$order->telegram_id) {
    return false;
}
```

**–£—Å–ª–æ–≤–∏—è:**
- –ë–æ—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏–º–µ–µ—Ç —Ç–æ–∫–µ–Ω
- –£ –∑–∞–∫–∞–∑–∞ –µ—Å—Ç—å `telegram_id` (ID –∫–ª–∏–µ–Ω—Ç–∞ –≤ Telegram)

#### –®–∞–≥ 2: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
```php
$message = $this->formatClientStatusMessage($order, $status, $details);
```

**–ü—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤:**

**–°—Ç–∞—Ç—É—Å `accepted`:**
```
‚úÖ –í–∞—à –∑–∞–∫–∞–∑ #ORD-20260126-328 –ø—Ä–∏–Ω—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É
```

**–°—Ç–∞—Ç—É—Å `sent_to_kitchen`:**
```
üë®‚Äçüç≥ –í–∞—à –∑–∞–∫–∞–∑ #ORD-20260126-328 –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –∫—É—Ö–Ω—é
```

**–°—Ç–∞—Ç—É—Å `kitchen_accepted`:**
```
üë®‚Äçüç≥ –í–∞—à –∑–∞–∫–∞–∑ #ORD-20260126-328 –ø—Ä–∏–Ω—è—Ç –Ω–∞ –∫—É—Ö–Ω–µ –∏ –Ω–∞—á–∞–ª –≥–æ—Ç–æ–≤–∏—Ç—å—Å—è
```

**–°—Ç–∞—Ç—É—Å `preparing`:**
```
üë®‚Äçüç≥ –í–∞—à –∑–∞–∫–∞–∑ #ORD-20260126-328 –≥–æ—Ç–æ–≤–∏—Ç—Å—è
```

**–°—Ç–∞—Ç—É—Å `ready_for_delivery`:**
```
‚úÖ –í–∞—à –∑–∞–∫–∞–∑ #ORD-20260126-328 –≥–æ—Ç–æ–≤ –∏ –æ–∂–∏–¥–∞–µ—Ç –∫—É—Ä—å–µ—Ä–∞
```

**–°—Ç–∞—Ç—É—Å `courier_assigned`:**
```
üöö –ö—É—Ä—å–µ—Ä –ò–≤–∞–Ω –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ –≤–∞—à –∑–∞–∫–∞–∑ #ORD-20260126-328
```

**–°—Ç–∞—Ç—É—Å `in_transit`:**
```
üöö –ö—É—Ä—å–µ—Ä –ò–≤–∞–Ω –∑–∞–±—Ä–∞–ª –≤–∞—à –∑–∞–∫–∞–∑ #ORD-20260126-328 –∏ —Å–ª–µ–¥—É–µ—Ç –ø–æ –∞–¥—Ä–µ—Å—É –¥–æ—Å—Ç–∞–≤–∫–∏
```

**–°—Ç–∞—Ç—É—Å `delivered`:**
```
üéâ –í–∞—à –∑–∞–∫–∞–∑ #ORD-20260126-328 –¥–æ—Å—Ç–∞–≤–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!
```

**–°—Ç–∞—Ç—É—Å `cancelled`:**
```
‚ùå –í–∞—à –∑–∞–∫–∞–∑ #ORD-20260126-328 –æ—Ç–º–µ–Ω–µ–Ω
```

#### –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
```php
$buttons = [];
if ($status === Order::STATUS_ACCEPTED || 
    (in_array($status, [Order::STATUS_SENT_TO_KITCHEN, Order::STATUS_PREPARING, Order::STATUS_READY_FOR_DELIVERY]) && 
     $order->status !== Order::STATUS_DELIVERED && 
     $order->status !== Order::STATUS_CANCELLED)) {
    $buttons = [
        [
            [
                'text' => '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑',
                'callback_data' => "order_cancel_request:{$order->id}"
            ]
        ]
    ];
}
```

**–ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:**
- –ü—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ `accepted`
- –ü—Ä–∏ —Å—Ç–∞—Ç—É—Å–∞—Ö `sent_to_kitchen`, `preparing`, `ready_for_delivery` (–µ—Å–ª–∏ –∑–∞–∫–∞–∑ –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –∏ –Ω–µ –æ—Ç–º–µ–Ω–µ–Ω)

#### –®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```php
return $this->updateClientNotification($order, $message, $buttons);
```

**–õ–æ–≥–∏–∫–∞ `updateClientNotification()`:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
2. –ï—Å–ª–∏ –µ—Å—Ç—å - –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `editMessageText()`
3. –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å (—Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ) - —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
4. –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î:**
- –¢–∏–ø: `OrderNotification::TYPE_CLIENT_STATUS`
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 24 —á–∞—Å–∞ (expires_at = now()->addHours(24))

---

## –õ–æ–≥–∏—á–µ—Å–∫–∞—è —Ü–µ–ø–æ—á–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 4.1. –ü–æ–ª–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞

```
1. –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ API
   ‚Üì
2. OrderController::store() —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'new'
   ‚Üì
3. OrderNotificationService::notifyAdminNewOrder() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
   ‚Üì
4. –ü–æ–∏—Å–∫ –≤—Å–µ—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –±–æ—Ç–∞ (role = 'admin', is_blocked = false)
   ‚Üì
5. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:
   a. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–∫–∞–∑–∞
   b. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –∫–Ω–æ–ø–∫–∞–º–∏ "‚úÖ –ü—Ä–∏–Ω—è—Ç—å" –∏ "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"
   c. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ TelegramService::sendMessage() (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
   d. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ë–î (—Ç–∏–ø: admin_new, expires_at: +5 –º–∏–Ω—É—Ç)
   ‚Üì
6. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
   ‚Üì
7. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "‚úÖ –ü—Ä–∏–Ω—è—Ç—å"
   ‚Üì
8. BotController –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback_query: order_admin_action:{order_id}:accept
   ‚Üì
9. BotController::handleAdminAcceptOrder() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
   ‚Üì
10. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞: 'new' ‚Üí 'accepted'
    ‚Üì
11. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
    ‚Üì
12. OrderNotificationService::notifyClientStatusChange() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
    ‚Üì
13. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "‚úÖ –í–∞—à –∑–∞–∫–∞–∑ #ORD-... –ø—Ä–∏–Ω—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É"
    ‚Üì
14. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î (—Ç–∏–ø: client_status, expires_at: +24 —á–∞—Å–∞)
```

### 4.2. –¶–µ–ø–æ—á–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

```
1. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"
   ‚Üì
2. BotController –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback_query: order_admin_action:{order_id}:cancel
   ‚Üì
3. BotController::handleAdminCancelOrder() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
   ‚Üì
4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –∫–µ—à–µ (10 –º–∏–Ω—É—Ç)
   ‚Üì
5. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: "‚ùì –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞"
   ‚Üì
6. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∏—á–∏–Ω–æ–π
   ‚Üì
7. BotController –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
   ‚Üì
8. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞: 'new' ‚Üí 'cancelled'
   ‚Üì
9. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–º–µ–Ω—ã –≤ –∑–∞–∫–∞–∑–µ
   ‚Üì
10. OrderNotificationService::notifyClientStatusChange() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
    ‚Üì
11. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "‚ùå –í–∞—à –∑–∞–∫–∞–∑ #ORD-... –æ—Ç–º–µ–Ω–µ–Ω"
```

---

## –§–æ—Ä–º–∞—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π

### 5.1. –°–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ –Ω–æ–≤–æ–º –∑–∞–∫–∞–∑–µ

**–ú–µ—Ç–æ–¥:** `formatAdminNewOrderMessage(Order $order)`

**–§–æ—Ä–º–∞—Ç:**
```
üÜï –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #ORD-20260126-328

üë§ –ö–ª–∏–µ–Ω—Ç: –ò–≥–æ—Ä—å
üìû –¢–µ–ª–µ—Ñ–æ–Ω: 79996371182
üìç –ê–¥—Ä–µ—Å: –°–∞–º–æ–≤—ã–≤–æ–∑
üïê –í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏: 26 —è–Ω–≤–∞—Ä—è, 16:00-17:00
üí∞ –°—É–º–º–∞: 14.94 ‚ÇΩ

üì¶ –¢–æ–≤–∞—Ä—ã:
‚Ä¢ –¢–µ—Å—Ç √ó 3 = 14.94 ‚ÇΩ

üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
```

**–ö–Ω–æ–ø–∫–∏:**
- `‚úÖ –ü—Ä–∏–Ω—è—Ç—å` ‚Üí callback_data: `order_admin_action:{order_id}:accept`
- `‚ùå –û—Ç–º–µ–Ω–∏—Ç—å` ‚Üí callback_data: `order_admin_action:{order_id}:cancel`

### 5.2. –°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–∫–∞–∑–∞

**–ú–µ—Ç–æ–¥:** `formatClientStatusMessage(Order $order, string $status, array $details)`

**–§–æ—Ä–º–∞—Ç –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ `accepted`:**
```
‚úÖ –í–∞—à –∑–∞–∫–∞–∑ #ORD-20260126-328 –ø—Ä–∏–Ω—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É
```

**–ö–Ω–æ–ø–∫–∏:**
- `‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑` ‚Üí callback_data: `order_cancel_request:{order_id}`

### 5.3. –°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞

**–°—Ç–∞—Ç—É—Å—ã –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**

| –°—Ç–∞—Ç—É—Å | –°–æ–æ–±—â–µ–Ω–∏–µ |
|--------|-----------|
| `accepted` | ‚úÖ –í–∞—à –∑–∞–∫–∞–∑ #{order_id} –ø—Ä–∏–Ω—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É |
| `sent_to_kitchen` | üë®‚Äçüç≥ –í–∞—à –∑–∞–∫–∞–∑ #{order_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –∫—É—Ö–Ω—é |
| `kitchen_accepted` | üë®‚Äçüç≥ –í–∞—à –∑–∞–∫–∞–∑ #{order_id} –ø—Ä–∏–Ω—è—Ç –Ω–∞ –∫—É—Ö–Ω–µ –∏ –Ω–∞—á–∞–ª –≥–æ—Ç–æ–≤–∏—Ç—å—Å—è |
| `preparing` | üë®‚Äçüç≥ –í–∞—à –∑–∞–∫–∞–∑ #{order_id} –≥–æ—Ç–æ–≤–∏—Ç—Å—è |
| `ready_for_delivery` | ‚úÖ –í–∞—à –∑–∞–∫–∞–∑ #{order_id} –≥–æ—Ç–æ–≤ –∏ –æ–∂–∏–¥–∞–µ—Ç –∫—É—Ä—å–µ—Ä–∞ |
| `courier_assigned` | üöö –ö—É—Ä—å–µ—Ä {courier_name} –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ –≤–∞—à –∑–∞–∫–∞–∑ #{order_id} |
| `in_transit` | üöö –ö—É—Ä—å–µ—Ä {courier_name} –∑–∞–±—Ä–∞–ª –≤–∞—à –∑–∞–∫–∞–∑ #{order_id} –∏ —Å–ª–µ–¥—É–µ—Ç –ø–æ –∞–¥—Ä–µ—Å—É –¥–æ—Å—Ç–∞–≤–∫–∏ |
| `delivered` | üéâ –í–∞—à –∑–∞–∫–∞–∑ #{order_id} –¥–æ—Å—Ç–∞–≤–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑! |
| `cancelled` | ‚ùå –í–∞—à –∑–∞–∫–∞–∑ #{order_id} –æ—Ç–º–µ–Ω–µ–Ω |

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

### 6.1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "‚úÖ –ü—Ä–∏–Ω—è—Ç—å"

**–§–∞–π–ª:** `app/Http/Controllers/Api/BotController.php`  
**–ú–µ—Ç–æ–¥:** `handleAdminAcceptOrder(Bot $bot, Order $order, TelegramUser $adminUser)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤:**
   ```php
   if ($adminUser->role !== TelegramUser::ROLE_ADMIN) {
       return; // –ù–µ—Ç –ø—Ä–∞–≤
   }
   ```

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞:**
   ```php
   $order->update(['status' => Order::STATUS_ACCEPTED]);
   ```

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:**
   - –ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–∏–ø–∞ `admin_new`
   - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ `editMessageText()`
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ "‚úÖ –°—Ç–∞—Ç—É—Å: –ü—Ä–∏–Ω—è—Ç"
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫)
   - –ü–æ–º–µ—á–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ (`markAsUpdated()`)

4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:**
   ```php
   $this->orderNotificationService->notifyClientStatusChange($order, Order::STATUS_ACCEPTED);
   ```

**–ù–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–Ω—è—Ç–∏—è:**
```
[‚úÖ –ü—Ä–∏–Ω—è—Ç—å] [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]
[üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∫—É—Ö–Ω—é]
[üí≥ –°—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É] (–µ—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞)
```

### 6.2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"

**–§–∞–π–ª:** `app/Http/Controllers/Api/BotController.php`  
**–ú–µ—Ç–æ–¥:** `handleAdminCancelOrder(Bot $bot, Order $order, TelegramUser $adminUser)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**
   ```php
   $cacheKey = "admin_cancel_order:{$bot->id}:{$adminUser->telegram_id}";
   Cache::put($cacheKey, [
       'order_id' => $order->id,
       'expires_at' => now()->addMinutes(10)->timestamp,
   ], now()->addMinutes(10));
   ```

2. **–ó–∞–ø—Ä–æ—Å –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–º–µ–Ω—ã:**
   ```
   ‚ùì –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞ #ORD-20260126-328:
   
   –ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–∏—á–∏–Ω–æ–π –æ—Ç–º–µ–Ω—ã.
   ```

3. **–û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞**

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏—á–∏–Ω—ã (–≤ –º–µ—Ç–æ–¥–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π):**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –∫–µ—à–µ
   - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞: `cancelled`
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–º–µ–Ω—ã
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –æ–± –æ—Ç–º–µ–Ω–µ

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### 7.1. –ú–æ–¥–µ–ª—å OrderNotification

**–¢–∞–±–ª–∏—Ü–∞:** `order_notifications`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- `id` - ID —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `order_id` - ID –∑–∞–∫–∞–∑–∞ (—Å–≤—è–∑—å —Å orders)
- `telegram_user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram (—Å–≤—è–∑—å —Å telegram_users)
- `message_id` - ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
- `chat_id` - ID —á–∞—Ç–∞ –≤ Telegram
- `notification_type` - –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `status` - –°—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (active, updated, deleted)
- `expires_at` - –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `created_at` - –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
- `updated_at` - –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–¢–∞–±–ª–∏—Ü–∞:** `order_notifications`

**–ü–æ–ª—è:**
- `id` - ID —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `order_id` - ID –∑–∞–∫–∞–∑–∞ (—Å–≤—è–∑—å —Å orders)
- `telegram_user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram (—Å–≤—è–∑—å —Å telegram_users)
- `message_id` - ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
- `chat_id` - ID —á–∞—Ç–∞ –≤ Telegram
- `notification_type` - –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `status` - –°—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `expires_at` - –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `created_at` - –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
- `updated_at` - –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### 7.2. –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```php
const TYPE_ADMIN_NEW = 'admin_new';           // –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
const TYPE_ADMIN_STATUS = 'admin_status';      // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
const TYPE_CLIENT_STATUS = 'client_status';    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
const TYPE_KITCHEN_ORDER = 'kitchen_order';    // –ó–∞–∫–∞–∑ –¥–ª—è –∫—É—Ö–Ω–∏
const TYPE_COURIER_ORDER = 'courier_order';    // –ó–∞–∫–∞–∑ –¥–ª—è –∫—É—Ä—å–µ—Ä–∞
```

### 7.3. –°—Ç–∞—Ç—É—Å—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```php
const STATUS_ACTIVE = 'active';    // –ê–∫—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
const STATUS_UPDATED = 'updated';  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ
const STATUS_DELETED = 'deleted';  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ
```

### 7.4. –°—Ä–æ–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

| –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è |
|----------------|---------------|
| `admin_new` | 5 –º–∏–Ω—É—Ç |
| `kitchen_order` | 10 –º–∏–Ω—É—Ç |
| `courier_order` | 15 –º–∏–Ω—É—Ç |
| `client_status` | 24 —á–∞—Å–∞ |
| `admin_status` | –ë–µ–∑ —Å—Ä–æ–∫–∞ (null) |

### 7.5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ú–µ—Ç–æ–¥:** `saveNotification(Order $order, TelegramUser $user, int $messageId, int $chatId, string $type, ?DateTime $expiresAt)`

**–ü—Ä–∏–º–µ—Ä:**
```php
OrderNotification::create([
    'order_id' => $order->id,
    'telegram_user_id' => $admin->id,
    'message_id' => $messageId,
    'chat_id' => $admin->telegram_id,
    'notification_type' => OrderNotification::TYPE_ADMIN_NEW,
    'status' => OrderNotification::STATUS_ACTIVE,
    'expires_at' => now()->addMinutes(5),
]);
```

### 7.6. –¢–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

| –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | –ü–æ–ª—É—á–∞—Ç–µ–ª—å | –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è | –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è | –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ/–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ |
|----------------|------------|---------------------|---------------|---------------------|
| `admin_new` | –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã | –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ | 5 –º–∏–Ω—É—Ç | –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ |
| `admin_status` | –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã | –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ | –ë–µ–∑ —Å—Ä–æ–∫–∞ | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–æ—á–µ—Ä–µ–¥—å) |
| `client_status` | –ö–ª–∏–µ–Ω—Ç | –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ | 24 —á–∞—Å–∞ | –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ |
| `kitchen_order` | –ö—É—Ö–Ω—è | –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞ –Ω–∞ –∫—É—Ö–Ω—é | 10 –º–∏–Ω—É—Ç | –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ |
| `courier_order` | –ö—É—Ä—å–µ—Ä | –ü—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞ –∫ –¥–æ—Å—Ç–∞–≤–∫–µ | 15 –º–∏–Ω—É—Ç | –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ |

### 7.7. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```
–°–æ–∑–¥–∞–Ω–∏–µ ‚Üí STATUS_ACTIVE ‚Üí –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Üí STATUS_UPDATED
                ‚Üì
         –ò—Å—Ç–µ—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ / –£–¥–∞–ª–µ–Ω–∏–µ ‚Üí STATUS_DELETED
```

**–°—Ç–∞—Ç—É—Å—ã:**
- `active` - –ê–∫—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å
- `updated` - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- `deleted` - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ (—Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–∑ Telegram)

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 8.1. –û—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**

1. **–ë–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:**
   ```php
   if (!$bot || !$bot->token) {
       Log::warning('Bot not found for order notification', ['order_id' => $order->id]);
       return false;
   }
   ```

2. **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã:**
   ```php
   if ($admins->isEmpty()) {
       Log::warning('No admins found for order notification', [
           'order_id' => $order->id,
           'bot_id' => $bot->id,
       ]);
       return false;
   }
   ```

3. **–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:**
   ```php
   if (!($result['success'] ?? false)) {
       Log::error('Failed to send admin notification', [
           'order_id' => $order->id,
           'admin_id' => $admin->id,
           'error' => $result['message'] ?? 'Unknown error',
       ]);
   }
   ```

4. **–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:**
   ```php
   catch (\Exception $e) {
       Log::error('Exception sending admin notification', [
           'order_id' => $order->id,
           'admin_id' => $admin->id,
           'error' => $e->getMessage(),
           'trace' => $e->getTraceAsString(),
       ]);
   }
   ```

### 8.2. –û—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**

1. **–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (–Ω–µ—Ç telegram_id):**
   ```php
   if (!$bot || !$bot->token || !$order->telegram_id) {
       return false;
   }
   ```

2. **–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:**
   - –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ (`MESSAGE_NOT_FOUND`) - —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
   - –ï—Å–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ - –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è false

3. **–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –æ—à–∏–±–∫–∞
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è false

### 8.3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:**
- –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –û—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
- –ò—Å–∫–ª—é—á–µ–Ω–∏—è

**–£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
- `Log::info()` - —É—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- `Log::warning()` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤, –±–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω)
- `Log::error()` - –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏, –∏—Å–∫–ª—é—á–µ–Ω–∏—è

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 9.1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞

**–ú–µ—Ç–æ–¥:** `updateClientNotification(Order $order, string $newText, array $newButtons = [])`

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞
2. –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ `editMessageText()`
3. –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ - –ø–æ–º–µ—Ç–∫–∞ –∫–∞–∫ `updated`
4. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
5. –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ—Ç - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ö–ª–∏–µ–Ω—Ç –≤–∏–¥–∏—Ç –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- –ù–µ –∑–∞—Å–æ—Ä—è–µ—Ç —á–∞—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞

### 9.2. –£–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–ú–µ—Ç–æ–¥—ã:**
- `deleteNotification(Order $order, TelegramUser $user, ?string $type)` - —É–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `deleteNotificationsForOrder(Order $order, ?string $type, array $excludeUserIds)` - —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–∫–∞–∑–∞ (—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏)

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
2. –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram —á–µ—Ä–µ–∑ `deleteMessage()`
3. –ü–æ–º–µ—á–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–∞–∫ `deleted` –≤ –ë–î

### 9.3. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ú–µ—Ç–æ–¥—ã:**
- `getCachedCouriers(int $botId)` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–æ–≤ (–∫—ç—à 10 –º–∏–Ω—É—Ç)
- `getCachedKitchenUsers(int $botId)` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ö–Ω–∏ (–∫—ç—à 10 –º–∏–Ω—É—Ç)
- `invalidateUserCache(int $botId)` - –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î
- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–ø–∏—Å–∫–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–µ–π

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 10.1. –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞

```php
// 1. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
$order = Order::create([...]);

// 2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
$orderNotificationService->notifyAdminNewOrder($order);
// –†–µ–∑—É–ª—å—Ç–∞—Ç: –í—Å–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏

// 3. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "‚úÖ –ü—Ä–∏–Ω—è—Ç—å"
// BotController –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback_query
// –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞: 'new' ‚Üí 'accepted'

// 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
$orderNotificationService->notifyClientStatusChange($order, Order::STATUS_ACCEPTED);
// –†–µ–∑—É–ª—å—Ç–∞—Ç: –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "‚úÖ –í–∞—à –∑–∞–∫–∞–∑ #ORD-... –ø—Ä–∏–Ω—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É"
```

### 10.2. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞

```php
// –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ –∫—É—Ö–Ω—é
$order->update(['status' => Order::STATUS_SENT_TO_KITCHEN]);
$orderNotificationService->notifyClientStatusChange($order, Order::STATUS_SENT_TO_KITCHEN);
// –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç: "üë®‚Äçüç≥ –í–∞—à –∑–∞–∫–∞–∑ #ORD-... –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –∫—É—Ö–Ω—é"

// –ü—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ
$order->update(['status' => Order::STATUS_DELIVERED]);
$orderNotificationService->notifyClientStatusChange($order, Order::STATUS_DELIVERED);
// –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç: "üéâ –í–∞—à –∑–∞–∫–∞–∑ #ORD-... –¥–æ—Å—Ç–∞–≤–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!"
```

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### 11.1. –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è vs –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞

**–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ):**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ –Ω–æ–≤–æ–º –∑–∞–∫–∞–∑–µ
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫—É—Ö–Ω–µ
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫—É—Ä—å–µ—Ä—É
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É

**–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (—á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å):**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `SendOrderNotificationJob`

### 11.2. Retry –º–µ—Ö–∞–Ω–∏–∑–º

**TelegramService** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫:
- –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ 429 (Too Many Requests)

### 11.3. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**–ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:**
- –°—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞ –∏ –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
- –ù–∞–ª–∏—á–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤, –∫–ª–∏–µ–Ω—Ç–∞)
- –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞
- –ù–∞–ª–∏—á–∏–µ telegram_id —É –∫–ª–∏–µ–Ω—Ç–∞

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞

### 12.1. –ü—Ä–æ—Ü–µ—Å—Å –æ—Ç–º–µ–Ω—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø—Ä–∏—á–∏–Ω—ã

**–§–∞–π–ª:** `app/Http/Controllers/Api/BotController.php`  
**–ú–µ—Ç–æ–¥:** `handleAdminCancelOrderReason(Bot $bot, int $chatId, string $text, array $from, array $cacheData)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**
   ```php
   $cacheKey = "admin_cancel_order:{$bot->id}:{$adminUser->telegram_id}";
   Cache::put($cacheKey, [
       'order_id' => $order->id,
       'expires_at' => now()->addMinutes(10)->timestamp,
   ], now()->addMinutes(10));
   ```

2. **–ó–∞–ø—Ä–æ—Å –ø—Ä–∏—á–∏–Ω—ã:**
   ```
   ‚ùì –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞ #ORD-20260126-328:
   
   –ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–∏—á–∏–Ω–æ–π –æ—Ç–º–µ–Ω—ã.
   ```

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏—á–∏–Ω—ã:**
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: 5 —Å–∏–º–≤–æ–ª–æ–≤
   - –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏ –≤–≤–æ–¥–∞
   - –ï—Å–ª–∏ –ø—Ä–∏—á–∏–Ω–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è - –∑–∞–ø—Ä–æ—Å –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏—á–∏–Ω—ã:**
   ```php
   // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
   $order->update([
       'status' => Order::STATUS_CANCELLED,
       'notes' => "–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã: {$text}"
   ]);
   
   // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   Cache::forget($cacheKey);
   
   // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
   $this->orderNotificationService->notifyClientStatusChange(
       $order, 
       Order::STATUS_CANCELLED,
       ['cancel_reason' => $text]
   );
   ```

5. **–£–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
   - –£–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫—É—Ö–Ω–µ (–µ—Å–ª–∏ –∑–∞–∫–∞–∑ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –∫—É—Ö–Ω—é)
   - –£–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫—É—Ä—å–µ—Ä–∞–º (–µ—Å–ª–∏ –∫—É—Ä—å–µ—Ä –±—ã–ª –Ω–∞–∑–Ω–∞—á–µ–Ω)
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É

---

## –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–º

### 12.2. –ü—Ä–æ—Ü–µ—Å—Å –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–º

**–§–∞–π–ª:** `app/Http/Controllers/Api/BotController.php`  
**–ú–µ—Ç–æ–¥:** –û–±—Ä–∞–±–æ—Ç–∫–∞ callback_query `order_cancel_request:{order_id}`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–º–µ–Ω—ã:**
   - –ó–∞–∫–∞–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å—Ç–∞—Ç—É—Å–µ `accepted`, `sent_to_kitchen`, `preparing`, `ready_for_delivery`
   - –ó–∞–∫–∞–∑ –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –∏–ª–∏ —É–∂–µ –æ—Ç–º–µ–Ω–µ–Ω

2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**
   ```php
   $cacheKey = "cancel_order:{$bot->id}:{$from['id']}";
   Cache::put($cacheKey, [
       'order_id' => $order->id,
       'expires_at' => now()->addMinutes(10)->timestamp,
   ], now()->addMinutes(10));
   ```

3. **–ó–∞–ø—Ä–æ—Å –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–º–µ–Ω—ã:**
   ```
   ‚ùì –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞ #ORD-20260126-328:
   
   –ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–∏—á–∏–Ω–æ–π –æ—Ç–º–µ–Ω—ã.
   ```

4. **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏—á–∏–Ω—ã:**
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: 5 —Å–∏–º–≤–æ–ª–æ–≤
   - –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏ –≤–≤–æ–¥–∞
   - –ï—Å–ª–∏ –ø—Ä–∏—á–∏–Ω–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è - –∑–∞–ø—Ä–æ—Å –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è

5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã:**
   ```php
   // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
   $previousStatus = $order->status;
   
   // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
   $order->update(['status' => Order::STATUS_CANCELLED]);
   
   // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
   $this->orderNotificationService->notifyAdminStatusChange($order, Order::STATUS_CANCELLED, [
       'message' => "–ó–∞–∫–∞–∑ #{$order->order_id} –æ—Ç–º–µ–Ω–µ–Ω –∫–ª–∏–µ–Ω—Ç–æ–º",
       'cancel_reason' => $text,
   ]);
   
   // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫—É—Ö–Ω–µ (–µ—Å–ª–∏ –∑–∞–∫–∞–∑ –±—ã–ª –Ω–∞ –∫—É—Ö–Ω–µ)
   if (in_array($previousStatus, [STATUS_SENT_TO_KITCHEN, STATUS_KITCHEN_ACCEPTED, ...])) {
       // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∫—É—Ö–Ω–∏
   }
   
   // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä—É (–µ—Å–ª–∏ –∫—É—Ä—å–µ—Ä –±—ã–ª –Ω–∞–∑–Ω–∞—á–µ–Ω)
   if ($order->courier_id) {
       // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫—É—Ä—å–µ—Ä—É
       // –£–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞
   }
   
   // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
   $this->orderNotificationService->notifyClientStatusChange($order, Order::STATUS_CANCELLED);
   ```

**–í–∞–∂–Ω–æ:**
- –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–æ–º —É–≤–µ–¥–æ–º–ª—è—é—Ç—Å—è –≤—Å–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –∫—É—Ö–Ω—è, –∫—É—Ä—å–µ—Ä)
- –£–¥–∞–ª—è—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞–º
- –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤

---

## –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Ä–æ–ª–µ–π: –ö—É—Ö–Ω—è –∏ –ö—É—Ä—å–µ—Ä

### 13.1. –û–±–∑–æ—Ä –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏ –≤–∫–ª—é—á–∞–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–µ–∂–¥—É —Å–ª–µ–¥—É—é—â–∏–º–∏ —Ä–æ–ª—è–º–∏:
- **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä** - —É–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–∫–∞–∑–∞–º–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –∫—É—Ö–Ω—é, –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –∫—É—Ä—å–µ—Ä–æ–≤
- **–ö—É—Ö–Ω—è (–ü–æ–≤–∞—Ä)** - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–∫–∞–∑—ã, –≥–æ—Ç–æ–≤–∏—Ç, –æ—Ç–º–µ—á–∞–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å
- **–ö—É—Ä—å–µ—Ä** - –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≥–æ—Ç–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞—Ö, –∑–∞–±–∏—Ä–∞–µ—Ç –∏ –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç

### 13.2. –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ü–û–õ–ù–´–ô –¶–ò–ö–õ –û–ë–†–ê–ë–û–¢–ö–ò –ó–ê–ö–ê–ó–ê                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–† ‚Üí –ö–£–•–ù–Ø
   ‚îú‚îÄ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "üë®‚Äçüç≥ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∫—É—Ö–Ω—é"
   ‚îú‚îÄ –°—Ç–∞—Ç—É—Å: accepted ‚Üí sent_to_kitchen
   ‚îú‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫—É—Ö–Ω–µ: "üë®‚Äçüç≥ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –¥–ª—è –∫—É—Ö–Ω–∏ #ORD-..."
   ‚îÇ  ‚îî‚îÄ –ö–Ω–æ–ø–∫–∞: "‚úÖ –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑"
   ‚îú‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: "–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –∫—É—Ö–Ω—é"
   ‚îî‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É: "üë®‚Äçüç≥ –í–∞—à –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –∫—É—Ö–Ω—é"

2. –ö–£–•–ù–Ø ‚Üí –ü–†–ò–ù–Ø–¢–ò–ï –ó–ê–ö–ê–ó–ê
   ‚îú‚îÄ –ü–æ–≤–∞—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "‚úÖ –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑"
   ‚îú‚îÄ –°—Ç–∞—Ç—É—Å: sent_to_kitchen ‚Üí kitchen_accepted ‚Üí preparing
   ‚îú‚îÄ –§–∏–∫—Å–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏: kitchen_started_at = now()
   ‚îú‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫—É—Ö–Ω–µ: "üç≥ –ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç, —Å—Ç–∞—Ç—É—Å: üî• –ì–æ—Ç–æ–≤–∏—Ç—Å—è"
   ‚îÇ  ‚îî‚îÄ –ö–Ω–æ–ø–∫–∞: "‚úÖ –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤"
   ‚îú‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: "–ö—É—Ö–Ω—è –ø—Ä–∏–Ω—è–ª–∞ –∑–∞–∫–∞–∑ #ORD-..."
   ‚îî‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É: "üë®‚Äçüç≥ –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –Ω–∞ –∫—É—Ö–Ω–µ –∏ –Ω–∞—á–∞–ª –≥–æ—Ç–æ–≤–∏—Ç—å—Å—è"

3. –ö–£–•–ù–Ø ‚Üí –ì–û–¢–û–í–ù–û–°–¢–¨ –ó–ê–ö–ê–ó–ê
   ‚îú‚îÄ –ü–æ–≤–∞—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "‚úÖ –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤"
   ‚îú‚îÄ –°—Ç–∞—Ç—É—Å: preparing ‚Üí ready_for_delivery
   ‚îú‚îÄ –§–∏–∫—Å–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏: kitchen_ready_at = now()
   ‚îú‚îÄ –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏: preparation_time_minutes = kitchen_ready_at - kitchen_started_at
   ‚îú‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫—É—Ö–Ω–µ: "üç≥ –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –¥–æ—Å—Ç–∞–≤–∫–µ"
   ‚îÇ  ‚îî‚îÄ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
   ‚îú‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: "–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –¥–æ—Å—Ç–∞–≤–∫–µ"
   ‚îú‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É: "‚úÖ –í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∏ –æ–∂–∏–¥–∞–µ—Ç –∫—É—Ä—å–µ—Ä–∞"
   ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è

4. –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–† ‚Üí –ö–£–†–¨–ï–† (–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ)
   ‚îú‚îÄ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "üöö –í—ã–∑–≤–∞—Ç—å –∫—É—Ä—å–µ—Ä–∞"
   ‚îú‚îÄ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –∫—É—Ä—å–µ—Ä–æ–≤ (–ø–æ 2 –≤ —Ä—è–¥)
   ‚îú‚îÄ –í–∞—Ä–∏–∞–Ω—Ç—ã:
   ‚îÇ  ‚îú‚îÄ –í—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞
   ‚îÇ  ‚îî‚îÄ "üì¢ –í—Å–µ –∫—É—Ä—å–µ—Ä—ã" (–æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º)
   ‚îú‚îÄ –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞:
   ‚îÇ  ‚îú‚îÄ –°—Ç–∞—Ç—É—Å: ready_for_delivery ‚Üí courier_assigned
   ‚îÇ  ‚îú‚îÄ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: courier_id = –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫—É—Ä—å–µ—Ä
   ‚îÇ  ‚îú‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä—É: "üöö –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –¥–æ—Å—Ç–∞–≤–∫–µ #ORD-..."
   ‚îÇ  ‚îÇ  ‚îî‚îÄ –ö–Ω–æ–ø–∫–∞: "‚úÖ –ó–∞–±—Ä–∞–ª –∑–∞–∫–∞–∑"
   ‚îÇ  ‚îú‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: "–ö—É—Ä—å–µ—Ä {–∏–º—è} –Ω–∞–∑–Ω–∞—á–µ–Ω"
   ‚îÇ  ‚îî‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É: "üöö –ö—É—Ä—å–µ—Ä {–∏–º—è} –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ –≤–∞—à –∑–∞–∫–∞–∑"
   ‚îî‚îÄ –ü—Ä–∏ –≤—ã–±–æ—Ä–µ "–í—Å–µ –∫—É—Ä—å–µ—Ä—ã":
      ‚îú‚îÄ –§–ª–∞–≥: assigned_to_all_couriers = true
      ‚îú‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∫—É—Ä—å–µ—Ä–∞–º: "üöö –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –¥–æ—Å—Ç–∞–≤–∫–µ"
      ‚îî‚îÄ –ü–µ—Ä–≤—ã–π –∫—É—Ä—å–µ—Ä, –Ω–∞–∂–∞–≤—à–∏–π "‚úÖ –ó–∞–±—Ä–∞–ª –∑–∞–∫–∞–∑", —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º

5. –ö–£–†–¨–ï–† ‚Üí –ó–ê–ë–†–ê–õ –ó–ê–ö–ê–ó
   ‚îú‚îÄ –ö—É—Ä—å–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "‚úÖ –ó–∞–±—Ä–∞–ª –∑–∞–∫–∞–∑"
   ‚îú‚îÄ –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤—Å–µ–º –∫—É—Ä—å–µ—Ä–∞–º:
   ‚îÇ  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –∑–∞–±—Ä–∞–ª –ª–∏ —É–∂–µ –¥—Ä—É–≥–æ–π –∫—É—Ä—å–µ—Ä
   ‚îÇ  ‚îú‚îÄ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: courier_id = —Ç–µ–∫—É—â–∏–π –∫—É—Ä—å–µ—Ä
   ‚îÇ  ‚îú‚îÄ –§–ª–∞–≥: assigned_to_all_couriers = false
   ‚îÇ  ‚îî‚îÄ –£–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤
   ‚îú‚îÄ –°—Ç–∞—Ç—É—Å: courier_assigned/ready_for_delivery ‚Üí in_transit
   ‚îú‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä—É: "‚úÖ –ó–∞–∫–∞–∑ –∑–∞–±—Ä–∞–Ω, –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏: ..."
   ‚îÇ  ‚îú‚îÄ –ö–Ω–æ–ø–∫–∞: "‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω"
   ‚îÇ  ‚îî‚îÄ –ö–Ω–æ–ø–∫–∞: "üí≥ –û–ø–ª–∞—á–µ–Ω" (–µ—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞)
   ‚îú‚îÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–¥—Ä–µ—Å–∞ —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–∞
   ‚îú‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: "–ö—É—Ä—å–µ—Ä {–∏–º—è} –∑–∞–±—Ä–∞–ª –∑–∞–∫–∞–∑"
   ‚îî‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É: "üöö –ö—É—Ä—å–µ—Ä {–∏–º—è} –∑–∞–±—Ä–∞–ª –≤–∞—à –∑–∞–∫–∞–∑ –∏ —Å–ª–µ–¥—É–µ—Ç –ø–æ –∞–¥—Ä–µ—Å—É"

6. –ö–£–†–¨–ï–† ‚Üí –î–û–°–¢–ê–í–ö–ê
   ‚îú‚îÄ –ö—É—Ä—å–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω"
   ‚îú‚îÄ –°—Ç–∞—Ç—É—Å: in_transit ‚Üí delivered
   ‚îú‚îÄ –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞:
   ‚îÇ  ‚îú‚îÄ –ó–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã: "üí≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã"
   ‚îÇ  ‚îî‚îÄ –ö–Ω–æ–ø–∫–∏: "‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞" / "‚ùå –û–ø–ª–∞—Ç–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞"
   ‚îú‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: "–ó–∞–∫–∞–∑ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –∫—É—Ä—å–µ—Ä–æ–º {–∏–º—è}"
   ‚îî‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É: "üéâ –í–∞—à –∑–∞–∫–∞–∑ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!"

7. –ö–£–†–¨–ï–† ‚Üí –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –û–ü–õ–ê–¢–´ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
   ‚îú‚îÄ –ö—É—Ä—å–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞"
   ‚îú‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: payment_status = succeeded
   ‚îî‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: "–û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞ –∫—É—Ä—å–µ—Ä–æ–º"
```

---

---

## –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –∫—É—Ö–Ω–∏

### 13.4. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ –Ω–∞ –∫—É—Ö–Ω—é

**–§–∞–π–ª:** `app/Http/Controllers/Api/BotController.php`  
**–ú–µ—Ç–æ–¥:** `handleSendToKitchen(Bot $bot, Order $order, TelegramUser $adminUser)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
   ```php
   if (!in_array($order->status, [Order::STATUS_NEW, Order::STATUS_ACCEPTED])) {
       throw new \Exception('Order status changed during processing');
   }
   ```

2. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ë–î:**
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–∫–∞–∑–∞ (`lockForUpdate()`)
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: `accepted` ‚Üí `sent_to_kitchen`
   - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –∑–∞–∫–∞–∑–∞ (`version++`)

3. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - **–ö—É—Ö–Ω–µ:** `notifyKitchenOrderSent($order)` - –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∫—É—Ö–Ω–∏
   - **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:** `notifyAdminStatusChange($order, STATUS_SENT_TO_KITCHEN)`
   - **–ö–ª–∏–µ–Ω—Ç—É:** `notifyClientStatusChange($order, STATUS_SENT_TO_KITCHEN)`

**–§–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫—É—Ö–Ω–µ:**
```
üë®‚Äçüç≥ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –¥–ª—è –∫—É—Ö–Ω–∏ #ORD-20260126-328

üì¶ –¢–æ–≤–∞—Ä—ã:
‚Ä¢ –¢–µ—Å—Ç √ó 3

üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
```

**–ö–Ω–æ–ø–∫–∞:** `‚úÖ –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑` ‚Üí callback_data: `order_kitchen_accept:{order_id}`

### 13.5. –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –∫—É—Ö–Ω–µ–π

**–§–∞–π–ª:** `app/Http/Controllers/Api/BotController.php`  
**–ú–µ—Ç–æ–¥:** `handleKitchenAccept(Bot $bot, string $orderId, array $from)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏:**
   ```php
   if ($telegramUser->role !== TelegramUser::ROLE_KITCHEN) {
       return; // –ù–µ—Ç –ø—Ä–∞–≤
   }
   ```

2. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ë–î:**
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–∫–∞–∑–∞
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `STATUS_SENT_TO_KITCHEN`
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤:
     - `sent_to_kitchen` ‚Üí `kitchen_accepted`
     - `kitchen_accepted` ‚Üí `preparing` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
   - –§–∏–∫—Å–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏: `kitchen_started_at = now()`
   - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫—É—Ö–Ω–µ:**
   ```
   üç≥ –ó–∞–∫–∞–∑ #ORD-20260126-328 –ø—Ä–∏–Ω—è—Ç
   
   –°—Ç–∞—Ç—É—Å: üî• –ì–æ—Ç–æ–≤–∏—Ç—Å—è
   
   üì¶ –¢–æ–≤–∞—Ä—ã:
   ‚Ä¢ –¢–µ—Å—Ç √ó 3
   
   –ù–∞–∂–º–∏—Ç–µ "–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤" –∫–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ.
   ```
   
   **–ö–Ω–æ–ø–∫–∞:** `‚úÖ –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤` ‚Üí callback_data: `order_kitchen_ready:{order_id}`

4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:** "–ö—É—Ö–Ω—è –ø—Ä–∏–Ω—è–ª–∞ –∑–∞–∫–∞–∑ #ORD-..."
   - **–ö–ª–∏–µ–Ω—Ç—É:** "üë®‚Äçüç≥ –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –Ω–∞ –∫—É—Ö–Ω–µ –∏ –Ω–∞—á–∞–ª –≥–æ—Ç–æ–≤–∏—Ç—å—Å—è"

**–í–∞–∂–Ω–æ:**
- –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ–≤–∞—Ä –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑ (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ –ë–î)
- –ï—Å–ª–∏ –∑–∞–∫–∞–∑ —É–∂–µ –ø—Ä–∏–Ω—è—Ç - –æ—à–∏–±–∫–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ–≤–∞—Ä–æ–≤

### 13.6. –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞ –Ω–∞ –∫—É—Ö–Ω–µ

**–§–∞–π–ª:** `app/Http/Controllers/Api/BotController.php`  
**–ú–µ—Ç–æ–¥:** `handleKitchenReady(Bot $bot, string $orderId, array $from)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
   ```php
   if (!in_array($order->status, [Order::STATUS_PREPARING, Order::STATUS_READY_FOR_DELIVERY])) {
       throw new \Exception('Order status not suitable for ready');
   }
   ```

2. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ë–î:**
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–∫–∞–∑–∞
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: `preparing` ‚Üí `ready_for_delivery`
   - –§–∏–∫—Å–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏: `kitchen_ready_at = now()`
   - –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:
     ```php
     $preparationTime = $order->kitchen_started_at->diffInMinutes($order->kitchen_ready_at);
     $order->preparation_time_minutes = $preparationTime;
     ```
   - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫—É—Ö–Ω–µ:**
   ```
   üç≥ –ó–∞–∫–∞–∑ #ORD-20260126-328 –≥–æ—Ç–æ–≤ –∫ –¥–æ—Å—Ç–∞–≤–∫–µ
   
   ‚úÖ –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ
   
   ‚è± –í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è: 15 –º–∏–Ω
   ```
   
   **–ö–Ω–æ–ø–∫–∏ —É–±–∏—Ä–∞—é—Ç—Å—è** (–∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤)

4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:** "–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –¥–æ—Å—Ç–∞–≤–∫–µ"
   - **–ö–ª–∏–µ–Ω—Ç—É:** "‚úÖ –í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∏ –æ–∂–∏–¥–∞–µ—Ç –∫—É—Ä—å–µ—Ä–∞"

5. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:**
   - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π `KitchenPreparationStatistic` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è, –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞, –ø–æ–≤–∞—Ä–∞

**–í–∞–∂–Ω–æ:**
- –ú–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å "–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤" –ø–æ–≤—Ç–æ—Ä–Ω–æ (idempotent)
- –ï—Å–ª–∏ –∑–∞–∫–∞–∑ —É–∂–µ –≥–æ—Ç–æ–≤ - –æ–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è

---

## –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –∫—É—Ä—å–µ—Ä–∞

### 13.7. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

**–§–∞–π–ª:** `app/Http/Controllers/Api/BotController.php`  
**–ú–µ—Ç–æ–¥:** `handleCallCourier(Bot $bot, Order $order, TelegramUser $adminUser)` ‚Üí `handleCourierAssign()`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
   ```php
   if (!in_array($order->status, [Order::STATUS_NEW, Order::STATUS_ACCEPTED, Order::STATUS_READY_FOR_DELIVERY])) {
       return; // –ù–µ–ª—å–∑—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∫—É—Ä—å–µ—Ä–∞
   }
   ```

2. **–ü–æ–∫–∞–∑ —Å–ø–∏—Å–∫–∞ –∫—É—Ä—å–µ—Ä–æ–≤:**
   - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–æ–≤ –∏–∑ –∫—ç—à–∞
   - –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–ø–æ 2 –∫—É—Ä—å–µ—Ä–∞ –≤ —Ä—è–¥)
   - –ö–Ω–æ–ø–∫–∞ "üì¢ –í—Å–µ –∫—É—Ä—å–µ—Ä—ã" –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏

3. **–í–∞—Ä–∏–∞–Ω—Ç 1: –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞**
   - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ë–î:
     - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–∫–∞–∑–∞
     - –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω –ª–∏ —É–∂–µ –¥—Ä—É–≥–æ–π –∫—É—Ä—å–µ—Ä
     - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: `courier_id = –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫—É—Ä—å–µ—Ä`
     - –§–ª–∞–≥: `assigned_to_all_couriers = false`
     - –°—Ç–∞—Ç—É—Å: `ready_for_delivery` ‚Üí `courier_assigned`
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
     - **–ö—É—Ä—å–µ—Ä—É:** "üöö –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –¥–æ—Å—Ç–∞–≤–∫–µ #ORD-..." —Å –∫–Ω–æ–ø–∫–æ–π "‚úÖ –ó–∞–±—Ä–∞–ª –∑–∞–∫–∞–∑"
     - **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:** "–ö—É—Ä—å–µ—Ä {–∏–º—è} –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ –∑–∞–∫–∞–∑"
     - **–ö–ª–∏–µ–Ω—Ç—É:** "üöö –ö—É—Ä—å–µ—Ä {–∏–º—è} –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ –≤–∞—à –∑–∞–∫–∞–∑"

4. **–í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º –∫—É—Ä—å–µ—Ä–∞–º**
   - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ë–î:
     - –§–ª–∞–≥: `assigned_to_all_couriers = true`
     - `courier_id = null` (–ø–æ–∫–∞ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω)
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
     - **–í—Å–µ–º –∫—É—Ä—å–µ—Ä–∞–º:** "üöö –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –¥–æ—Å—Ç–∞–≤–∫–µ" —Å –∫–Ω–æ–ø–∫–æ–π "‚úÖ –ó–∞–±—Ä–∞–ª –∑–∞–∫–∞–∑"
     - **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:** "–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤—Å–µ–º –∫—É—Ä—å–µ—Ä–∞–º (N —á–µ–ª.)"
   - **–õ–æ–≥–∏–∫–∞:** –ü–µ—Ä–≤—ã–π –∫—É—Ä—å–µ—Ä, –Ω–∞–∂–∞–≤—à–∏–π "‚úÖ –ó–∞–±—Ä–∞–ª –∑–∞–∫–∞–∑", —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º

### 13.8. –ö—É—Ä—å–µ—Ä –∑–∞–±–∏—Ä–∞–µ—Ç –∑–∞–∫–∞–∑

**–§–∞–π–ª:** `app/Http/Controllers/Api/BotController.php`  
**–ú–µ—Ç–æ–¥:** `handleCourierPicked(Bot $bot, string $orderId, array $from)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
   ```php
   if (!in_array($order->status, [Order::STATUS_COURIER_ASSIGNED, Order::STATUS_READY_FOR_DELIVERY])) {
       throw new \Exception('Order status not suitable');
   }
   ```

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:**

   **–°—Ü–µ–Ω–∞—Ä–∏–π A: –ó–∞–∫–∞–∑ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤—Å–µ–º –∫—É—Ä—å–µ—Ä–∞–º**
   ```php
   if ($order->assigned_to_all_couriers) {
       // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –∑–∞–±—Ä–∞–ª –ª–∏ —É–∂–µ –¥—Ä—É–≥–æ–π –∫—É—Ä—å–µ—Ä
       if ($order->courier_id && $order->courier_id !== $telegramUser->id) {
           throw new \Exception('Order already picked by another courier');
       }
       // –ù–∞–∑–Ω–∞—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Ä—å–µ—Ä–∞
       $order->courier_id = $telegramUser->id;
       $order->assigned_to_all_couriers = false;
   }
   ```

   **–°—Ü–µ–Ω–∞—Ä–∏–π B: –ö—É—Ä—å–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω, –Ω–æ –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤**
   ```php
   elseif (!$order->courier_id) {
       // –ù–∞–∑–Ω–∞—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Ä—å–µ—Ä–∞
       $order->courier_id = $telegramUser->id;
   }
   ```

   **–°—Ü–µ–Ω–∞—Ä–∏–π C: –ö—É—Ä—å–µ—Ä —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω**
   ```php
   else {
       // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –∫—É—Ä—å–µ—Ä
       if ($order->courier_id !== $telegramUser->id) {
           throw new \Exception('Courier not assigned to this order');
       }
   }
   ```

3. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ë–î:**
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–∫–∞–∑–∞
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: `courier_assigned/ready_for_delivery` ‚Üí `in_transit`
   - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏

4. **–£–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
   - –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤—Å–µ–º –∫—É—Ä—å–µ—Ä–∞–º:
     - –£–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —É –≤—Å–µ—Ö –∫—É—Ä—å–µ—Ä–æ–≤, –∫—Ä–æ–º–µ —Ç–æ–≥–æ, –∫—Ç–æ –∑–∞–±—Ä–∞–ª
     - –ú–µ—Ç–æ–¥: `deleteNotificationsForOrder($order, TYPE_COURIER_ORDER, [$excludeIds])`

5. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - **–ö—É—Ä—å–µ—Ä—É:** `notifyCourierInTransit($order, $courier)` - –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–¥—Ä–µ—Å–æ–º
   - **–ö–ª–∏–µ–Ω—Ç—É:** "üöö –ö—É—Ä—å–µ—Ä {–∏–º—è} –∑–∞–±—Ä–∞–ª –≤–∞—à –∑–∞–∫–∞–∑ –∏ —Å–ª–µ–¥—É–µ—Ç –ø–æ –∞–¥—Ä–µ—Å—É"
   - **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:** "–ö—É—Ä—å–µ—Ä {–∏–º—è} –∑–∞–±—Ä–∞–ª –∑–∞–∫–∞–∑"

6. **–û—Ç–ø—Ä–∞–≤–∫–∞ –∞–¥—Ä–µ—Å–∞ —Å –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–æ–º:**
   - –ú–µ—Ç–æ–¥: `sendDeliveryAddressToCourier($bot, $order, $courier)`
   - –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∞–¥—Ä–µ—Å–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–µ (–µ—Å–ª–∏ –∞–¥—Ä–µ—Å –≤–∞–ª–∏–¥–Ω—ã–π)

### 13.9. –ö—É—Ä—å–µ—Ä –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–∫–∞–∑

**–§–∞–π–ª:** `app/Http/Controllers/Api/BotController.php`  
**–ú–µ—Ç–æ–¥:** `handleCourierDelivered(Bot $bot, string $orderId, array $from)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
   ```php
   if ($order->status !== Order::STATUS_IN_TRANSIT) {
       return; // –ó–∞–∫–∞–∑ –Ω–µ –≤ –ø—É—Ç–∏
   }
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:**
   ```php
   if ($order->courier_id !== $telegramUser->id) {
       throw new \Exception('Courier not assigned to this order');
   }
   ```

3. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ë–î:**
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–∫–∞–∑–∞
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: `in_transit` ‚Üí `delivered`
   - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã:**
   - –ï—Å–ª–∏ `payment_status === PENDING`:
     - –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:
       ```
       ‚úÖ –ó–∞–∫–∞–∑ #ORD-20260126-328 –¥–æ—Å—Ç–∞–≤–ª–µ–Ω
       
       üí≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã
       üí∞ –°—É–º–º–∞: 14.94 ‚ÇΩ
       
       –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã:
       ```
     - –ö–Ω–æ–ø–∫–∏:
       - `‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞` ‚Üí callback_data: `order_payment:{order_id}:received`
       - `‚ùå –û–ø–ª–∞—Ç–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞` ‚Üí callback_data: `order_payment:{order_id}:not_received`
   - –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–∞ - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º

5. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:** "–ó–∞–∫–∞–∑ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –∫—É—Ä—å–µ—Ä–æ–º {–∏–º—è}"
   - **–ö–ª–∏–µ–Ω—Ç—É:** "üéâ –í–∞—à –∑–∞–∫–∞–∑ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!"

### 13.10. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –∫—É—Ä—å–µ—Ä–æ–º

**–§–∞–π–ª:** `app/Http/Controllers/Api/BotController.php`  
**–ú–µ—Ç–æ–¥:** `handleOrderPayment(Bot $bot, string $orderId, string $param, array $from)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏:**
   - –¢–æ–ª—å–∫–æ –∫—É—Ä—å–µ—Ä –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞:**
   - –ï—Å–ª–∏ `param === 'received'`:
     - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: `payment_status = succeeded`
     - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: "–û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞ –∫—É—Ä—å–µ—Ä–æ–º"
   - –ï—Å–ª–∏ `param === 'not_received'`:
     - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
     - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: "–û–ø–ª–∞—Ç–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞ –∫—É—Ä—å–µ—Ä–æ–º"

---

## –°—Ö–µ–º—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

### 13.11. –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: –ö—É—Ö–Ω—è

```
–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä          –ö—É—Ö–Ω—è              –ö–ª–∏–µ–Ω—Ç            –°–∏—Å—Ç–µ–º–∞
     |                   |                  |                  |
     |--[–û—Ç–ø—Ä–∞–≤–∏—Ç—å]----->|                  |                  |
     |                   |                  |                  |
     |                   |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]--|                  |
     |                   |                  |                  |
     |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]---|                  |                  |
     |                   |                  |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]--|
     |                   |                  |                  |
     |                   |--[–ü—Ä–∏–Ω—è—Ç—å]------>|                  |
     |                   |                  |                  |
     |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]---|                  |                  |
     |                   |                  |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]--|
     |                   |                  |                  |
     |                   |--[–ì–æ—Ç–æ–≤]-------->|                  |
     |                   |                  |                  |
     |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]---|                  |                  |
     |                   |                  |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]--|
```

### 13.12. –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: –ö—É—Ä—å–µ—Ä

```
–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä          –ö—É—Ä—å–µ—Ä              –ö–ª–∏–µ–Ω—Ç            –°–∏—Å—Ç–µ–º–∞
     |                   |                  |                  |
     |--[–ù–∞–∑–Ω–∞—á–∏—Ç—å]----->|                  |                  |
     |                   |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]--|                  |
     |                   |                  |                  |
     |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]---|                  |                  |
     |                   |                  |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]--|
     |                   |                  |                  |
     |                   |--[–ó–∞–±—Ä–∞–ª]------->|                  |
     |                   |                  |                  |
     |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]---|                  |                  |
     |                   |                  |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]--|
     |                   |                  |                  |
     |                   |--[–î–æ—Å—Ç–∞–≤–ª–µ–Ω]----->|                  |
     |                   |                  |                  |
     |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]---|                  |                  |
     |                   |                  |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]--|
     |                   |                  |                  |
     |                   |--[–û–ø–ª–∞—Ç–∞]-------->|                  |
     |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]---|                  |                  |
```

### 13.13. –°—Ü–µ–Ω–∞—Ä–∏–π "–í—Å–µ –∫—É—Ä—å–µ—Ä—ã"

```
–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä          –ö—É—Ä—å–µ—Ä 1            –ö—É—Ä—å–µ—Ä 2            –°–∏—Å—Ç–µ–º–∞
     |                   |                   |                   |
     |--[–í—Å–µ –∫—É—Ä—å–µ—Ä—ã]--->|                   |                   |
     |                   |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]---|                   |
     |                   |                   |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]---|
     |                   |                   |                   |
     |                   |--[–ó–∞–±—Ä–∞–ª]-------->|                   |
     |                   |                   |                   |
     |                   |                   |<--[–£–¥–∞–ª–µ–Ω–∏–µ]-----|
     |<--[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]---|                   |                   |
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –í—Å–µ –∫—É—Ä—å–µ—Ä—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ü–µ—Ä–≤—ã–π, –Ω–∞–∂–∞–≤—à–∏–π "–ó–∞–±—Ä–∞–ª –∑–∞–∫–∞–∑", —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º
- –£ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race condition —á–µ—Ä–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ë–î

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

### 13.14. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö:**

1. **–ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –∫—É—Ö–Ω–µ–π:**
   ```php
   DB::transaction(function () {
       $order = Order::lockForUpdate()->first();
       // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
       // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
   });
   ```

2. **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞:**
   ```php
   DB::transaction(function () {
       $order = Order::lockForUpdate()->first();
       // –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
       // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
   });
   ```

3. **–ó–∞–±—Ä–∞–ª –∑–∞–∫–∞–∑ –∫—É—Ä—å–µ—Ä–æ–º:**
   ```php
   DB::transaction(function () {
       $order = Order::lockForUpdate()->first();
       // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
       // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
       // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
   });
   ```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race conditions
- –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

### 13.15. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ú–µ—Ç–æ–¥—ã:**
- `getCachedKitchenUsers($botId)` - –∫—ç—à 10 –º–∏–Ω—É—Ç
- `getCachedCouriers($botId)` - –∫—ç—à 10 –º–∏–Ω—É—Ç

**–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è:**
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ú–µ—Ç–æ–¥: `invalidateUserCache($botId)`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î
- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–ø–∏—Å–∫–∞–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

### 13.16. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è

**–ü—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**

1. **–¢–∞–±–ª–∏—Ü–∞:** `kitchen_preparation_statistics`
2. **–ü–æ–ª—è:**
   - `order_id` - ID –∑–∞–∫–∞–∑–∞
   - `product_id` - ID —Ç–æ–≤–∞—Ä–∞
   - `product_name` - –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
   - `quantity` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
   - `preparation_time_minutes` - –í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
   - `kitchen_user_id` - ID –ø–æ–≤–∞—Ä–∞
   - `prepared_at` - –í—Ä–µ–º—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
   - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
   - –û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å

---

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### 14.1. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω–æ–º –∑–∞–∫–∞–∑–µ (—á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç)

**–ú–µ—Ç–æ–¥:** `notifyClientUnpaidAfter10Minutes(Order $order)`

**–£—Å–ª–æ–≤–∏—è:**
- –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω –±–æ–ª–µ–µ 10 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
- –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã: `pending`
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `notification_10min_enabled` –≤–∫–ª—é—á–µ–Ω–∞

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
–í—ã –æ—Ñ–æ—Ä–º–∏–ª–∏ –∑–∞–∫–∞–∑ ‚ÑñORD-20260126-328 –Ω–∞ 14.94 ‚ÇΩ.
–ß—Ç–æ–±—ã –º—ã –Ω–∞—á–∞–ª–∏ –≥–æ—Ç–æ–≤–∏—Ç—å, –æ–ø–ª–∞—Ç–∏—Ç–µ –∑–∞–∫–∞–∑.
```

**–ö–Ω–æ–ø–∫–∏:**
- `üí≥ –û–ø–ª–∞—Ç–∏—Ç—å` ‚Üí callback_data: `order_pay:{order_id}`
- `‚ùå –û—Ç–º–µ–Ω–∏—Ç—å` ‚Üí callback_data: `order_cancel_request:{order_id}`

### 14.2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 5 –º–∏–Ω—É—Ç –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è TTL

**–ú–µ—Ç–æ–¥:** `notifyClient5MinutesBeforeTTL(Order $order)`

**–£—Å–ª–æ–≤–∏—è:**
- –ó–∞–∫–∞–∑ –Ω–µ –æ–ø–ª–∞—á–µ–Ω
- –î–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è TTL –æ—Å—Ç–∞–ª–æ—Å—å 5 –º–∏–Ω—É—Ç
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `notification_5min_before_ttl_enabled` –≤–∫–ª—é—á–µ–Ω–∞

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
–ó–∞–∫–∞–∑ ‚ÑñORD-20260126-328 –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω—ë–Ω —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç, –µ—Å–ª–∏ –Ω–µ –æ–ø–ª–∞—Ç–∏—Ç—å.
```

**–ö–Ω–æ–ø–∫–∏:**
- `üí≥ –û–ø–ª–∞—Ç–∏—Ç—å` ‚Üí callback_data: `order_pay:{order_id}`
- `‚ùå –û—Ç–º–µ–Ω–∏—Ç—å` ‚Üí callback_data: `order_cancel_request:{order_id}`

---

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏

### 15.1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –û–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
- –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ - —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–æ–µ
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è —á–µ—Ä–µ–∑ —Å—Ç–∞—Ç—É—Å—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (`active` ‚Üí `updated`)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ö–ª–∏–µ–Ω—Ç –≤–∏–¥–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
- –ù–µ –∑–∞—Å–æ—Ä—è–µ—Ç —á–∞—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π
- –õ–µ–≥–∫–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 15.2. –£–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–°—Ü–µ–Ω–∞—Ä–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è:**
1. –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞ - —É–¥–∞–ª—è—é—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫—É—Ö–Ω–µ –∏ –∫—É—Ä—å–µ—Ä–∞–º
2. –ü—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –∫—É—Ä—å–µ—Ä–∞ - —É–¥–∞–ª—è—é—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥—Ä—É–≥–∏–º –∫—É—Ä—å–µ—Ä–∞–º
3. –ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `expires_at`

**–ú–µ—Ç–æ–¥—ã:**
- `deleteNotification()` - —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `deleteNotificationsForOrder()` - –º–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏

---

## –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å

### 16.1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ë–î

**–ü—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º:**
```php
DB::transaction(function () use ($order, $adminUser, $bot) {
    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è
    $order = Order::where('id', $order->id)->lockForUpdate()->first();
    
    // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    if ($order->status !== Order::STATUS_NEW) {
        throw new \Exception('Order status changed during processing');
    }
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    $this->orderStatusService->changeStatus($order, Order::STATUS_ACCEPTED, [...]);
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
});
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ì–∞—Ä–∞–Ω—Ç–∏—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race conditions
- –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ –æ—à–∏–±–∫–µ

### 16.2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–ø–∏—Å–µ–π

**–ú–µ—Ç–æ–¥:** `lockForUpdate()`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ü—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
- –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤

**–¶–µ–ª—å:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏

---

## –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 17.1. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```
–ö–ª–∏–µ–Ω—Ç ‚Üí API ‚Üí OrderController::store()
                ‚Üì
            –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (status: 'new')
                ‚Üì
            OrderNotificationService::notifyAdminNewOrder()
                ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ –ü–æ–∏—Å–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤                 ‚îÇ
        ‚îÇ (role = 'admin', is_blocked = false)  ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:          ‚îÇ
        ‚îÇ 1. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è          ‚îÇ
        ‚îÇ 2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã           ‚îÇ
        ‚îÇ 3. –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ TelegramService    ‚îÇ
        ‚îÇ 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î (admin_new)       ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚Üì
        –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                ‚Üì
        –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "‚úÖ –ü—Ä–∏–Ω—è—Ç—å"
                ‚Üì
        BotController::handleAdminAcceptOrder()
                ‚Üì
        –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: 'new' ‚Üí 'accepted'
                ‚Üì
        –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
                ‚Üì
        OrderNotificationService::notifyClientStatusChange()
                ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ –î–ª—è –∫–ª–∏–µ–Ω—Ç–∞:                          ‚îÇ
        ‚îÇ 1. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è           ‚îÇ
        ‚îÇ 2. –ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è       ‚îÇ
        ‚îÇ 3. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ‚îÇ
        ‚îÇ 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î (client_status)   ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚Üì
        –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

### 17.2. –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

```
–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ‚Üí "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"
                ‚Üì
        BotController::handleAdminCancelOrder()
                ‚Üì
        –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –∫–µ—à–µ (10 –º–∏–Ω)
                ‚Üì
        –ó–∞–ø—Ä–æ—Å –ø—Ä–∏—á–∏–Ω—ã: "‚ùì –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É..."
                ‚Üì
        –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ‚Üí –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                ‚Üì
        BotController::handleAdminCancelOrderReason()
                ‚Üì
        –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏—á–∏–Ω—ã (–º–∏–Ω. 5 —Å–∏–º–≤–æ–ª–æ–≤)
                ‚Üì
        –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: 'new' ‚Üí 'cancelled'
        –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –≤ notes
                ‚Üì
        OrderNotificationService::notifyClientStatusChange()
                ‚Üì
        –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç: "‚ùå –í–∞—à –∑–∞–∫–∞–∑ #ORD-... –æ—Ç–º–µ–Ω–µ–Ω"
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∑–∞–∫–∞–∑–∞—Ö –≤ Telegram –±–æ—Ç–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

1. **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤** –æ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞—Ö —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–Ω—è—Ç–∏—è/–æ—Ç–º–µ–Ω—ã
2. **–ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤** –æ —Å—Ç–∞—Ç—É—Å–µ –∏—Ö –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
3. **–ù–∞–¥–µ–∂–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ë–î –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
4. **–ì–∏–±–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, –∏—Å—Ç–µ—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞)
5. **–û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫** —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
6. **–î–≤—É—Ö—ç—Ç–∞–ø–Ω—É—é –æ—Ç–º–µ–Ω—É** —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø—Ä–∏—á–∏–Ω—ã
7. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è** –æ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞—Ö

–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã.

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:

- ‚úÖ **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞** –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É, –∫–ª–∏–µ–Ω—Ç—É)
- ‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞** –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å)
- ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è** –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
- ‚úÖ **–°—Ä–æ–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏
- ‚úÖ **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î** –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ **Retry –º–µ—Ö–∞–Ω–∏–∑–º** –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
- ‚úÖ **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
